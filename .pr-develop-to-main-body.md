# Release: E2E coverage, auth handoff fixes, and logout cookie semantics

This PR promotes **develop** into **main**, bringing in E2E test expansion, marketing auth-handoff hardening, and a fix for logout cookie semantics so only `jhai_auth=logged_out` is treated as the logout signal.

---

## Summary

- **E2E coverage**: New and hardened Playwright tests for auth, logout, marketing handoff, account settings, billing portal, error handling, and real API smoke.
- **Auth handoff**: Marketing auth-handoff test and navigation/cookie logic updated so handoff clearing and logout signals are correct and testable.
- **Logout cookie**: `jhai_auth=0` is no longer treated as a logout signal; only `jhai_auth=logged_out` is, avoiding collision with unverified-user semantics and matching app behavior.

---

## What’s included

### 1. E2E test expansion and reliability (from dev0 / PR #584 and follow-ups)

**Auth and protected routes**
- Logout flow test: logout from account settings, then confirm redirect to login and that a new tab visiting dashboard is sent to login/verify-email with no authenticated nav.
- Protected-route tests for `/resume-feedback-pro.html` and `/account-setting.html` with unauthenticated context; both must redirect to login or verify-email.
- Browser contexts wrapped in try/finally so `context.close()` always runs and tests don’t leak.

**Marketing auth handoff**
- New test: marketing site shows visitor nav after handoff is cleared (sessionStorage handoff removed + logout cookie set, then reload).
- Precondition requires authenticated nav to be visible before clearing, so the test always exercises handoff behavior.
- Skip guard uses `MARKETING_BASE` hostname (jobhackai.io or subdomain) so the test only runs when the marketing URL is the real marketing site.
- Logout signal: sets `jhai_auth=logged_out` for both domain-scoped and host-only cookies so any existing `jhai_auth` cookie is overwritten.
- Stale-auth check uses a broader set of nav selectors (e.g. dashboard links, nav dropdown, user toggle) so regressions in handoff clearing are caught.

**Account settings and billing**
- Account settings page load, billing portal API (accepts 200/400/401/403/404/500; on 200 asserts Stripe portal URL), and logout from account settings.

**Error handling and real API smoke**
- Error-handling smoke: mock `/api/plan/me` to 500, require auth and dashboard load, assert no critical page errors and that the mocked route was hit.
- Real API smoke: `/api/plan/me` and `/api/billing-status` with auth; billing-status 200 must have a non-empty JSON body.

**Env loader**
- Playwright env loading order: `.env` then `.env.test.local` so local overrides (e.g. TEST_EMAIL, TEST_PASSWORD) win.

### 2. Logout cookie semantics (PR #586)

**Navigation (app and marketing)**
- `hasCrossDomainLogoutCookie()` now treats only `jhai_auth=logged_out` as the logout signal.
- `jhai_auth=0` is no longer treated as logout; it remains for unverified-but-authenticated users, avoiding collision with the “logged out” state.

**Why**
- Prevents cases where setting `jhai_auth=0` for one flow was interpreted as “logged out” and caused incorrect nav or handoff behavior on the marketing site.

### 3. E2E reliability and correctness (PR #585)

- Billing portal test accepts valid non-200 responses and only asserts Stripe URL on 200.
- Logout redirect test waits for URL with `waitForURL` instead of a fixed timeout.
- Error-handling smoke requires authenticated dashboard load and that the plan/me mock was hit.
- Billing-status smoke asserts non-empty body on 200.
- Marketing cookie domain derived from `MARKETING_BASE`; skip and host checks aligned with the URL under test.

---

## Testing

- E2E suite run from `app/`: `npm run test:e2e` (relevant specs: Account Settings, Authentication, Marketing Site Auth, Error Handling, Real API Smoke).
- Auth handoff and logout behavior verified against jobhackai.io marketing flow.

---

## Deploy notes

- No new env vars or feature flags.
- Marketing and app both use the updated navigation logic (app: `js/navigation.js`, marketing: `marketing/js/navigation.js`); keep the two in sync per project conventions.

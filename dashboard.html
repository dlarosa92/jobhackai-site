<!-- DO NOT EDIT HEADER OR FOOTER PER-PAGE. Use canonical snippet from docs/snippets.md. -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>html.auth-pending{visibility:hidden}</style>
  <script src="js/redirect-tracer.js?v=1"></script>
  <script src="js/static-auth-guard.js?v=20251007-2"></script>
  <title>JobHackAI</title>
  <link rel="icon" type="image/png" href="assets/jobhackai_icon_only_128.png">
  <link rel="apple-touch-icon" href="assets/jobhackai_icon_only_128.png">
  <script src="js/dynamic-favicon.js?v=20250111-1"></script>
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/footer.css">
  <script type="module">
    import authManager from './js/firebase-auth.js';
    document.documentElement.classList.add('auth-pending');
    (async () => {
      try {
        const user = await authManager.waitForAuthReady(4000);
        if (!user) {
          location.replace('/login');
          return;
        }
      } catch (_) {
        // Conservative fallback
        location.replace('/login');
        return;
      } finally {
        document.documentElement.classList.remove('auth-pending');
      }
    })();
  </script>
  <style>
    .dashboard-banner {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(31,41,55,0.07);
      padding: 1.2rem 2rem 1.2rem 2rem;
      margin: 2rem auto 2.2rem auto;
      max-width: 540px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      position: relative;
      align-items: flex-start;
    }
    .dashboard-banner .settings-link {
      position: absolute;
      top: 1.1rem;
      right: 1.2rem;
      color: #6B7280;
      font-size: 1.1rem;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.2rem;
      transition: color 0.18s;
      opacity: 0.7;
    }
    .dashboard-banner .settings-link:hover {
      color: #232B36;
      text-decoration: underline;
      opacity: 1;
    }
    .dashboard-banner .welcome-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.08rem;
      margin-bottom: 0.1rem;
    }
    .dashboard-banner .welcome-row h2 {
      font-size: 1.32rem;
      font-weight: 800;
      color: #232B36;
      margin: 0 0 0.08rem 0;
      padding: 0;
    }
    .dashboard-banner .trial-countdown {
      color: #D97706;
      font-weight: 600;
      font-size: 1.01rem;
      margin: 0.05rem 0 0.05rem 0;
      padding: 0;
      line-height: 1.2;
    }
    .dashboard-banner .user-email {
      font-size: 0.98rem;
      color: #6B7280;
      margin-bottom: 0.1rem;
      font-weight: 400;
      letter-spacing: 0.01em;
    }
    .dashboard-banner .plan-badge {
      display: inline-block;
      background: #F3F4F6;
      color: #0077B5;
      font-weight: 700;
      border-radius: 8px;
      padding: 0.18rem 0.7rem;
      font-size: 0.98rem;
      margin-left: 0;
      margin-top: 0.2rem;
    }
    .dashboard-banner .upgrade-btn {
      background: #00E676;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.5rem;
      font-size: 1.01rem;
      cursor: pointer;
      margin-top: 0.5rem;
      align-self: flex-start;
      transition: background 0.18s;
      text-decoration: none;
      display: inline-block;
    }
    .dashboard-banner .upgrade-btn:hover,
    .dashboard-banner .upgrade-btn:focus {
      background: #00c965;
      text-decoration: none;
      outline: none;
    }
    .dashboard-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
      gap: 1.5rem;
      max-width: 1100px;
      margin: 0 auto 2.5rem auto;
    }
    .feature-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(31,41,55,0.07);
      padding: 1.5rem 1.2rem 1.2rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      align-items: flex-start;
      min-height: 210px;
      position: relative;
    }
    .feature-card.locked {
      opacity: 0.7;
    }
    .feature-card .feature-title {
      font-size: 1.13rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
      color: #232B36;
    }
    .feature-card .feature-desc {
      font-size: 1rem;
      color: #4B5563;
      margin-bottom: 0.7rem;
    }
    .feature-card .feature-action {
      margin-top: auto;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .feature-card .feature-action .btn-primary,
    .feature-card .feature-action a.btn-primary {
      padding: 0.7rem 1.5rem;
    }
    .feature-card .feature-action .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #fff !important;
      color: #1976D2 !important;
      border: 1.5px solid #1976D2;
      font-weight: 600;
      border-radius: 12px;
      font-size: 1.02rem;
      min-width: 160px;
      font-family: 'Inter', Arial, sans-serif;
      text-align: center;
      text-decoration: none;
      transition: background 0.18s, color 0.18s, border-color 0.18s;
      cursor: pointer;
    }
    .feature-card .feature-action .btn-primary:hover,
    .feature-card .feature-action .btn-primary:focus {
      background: #1976D2 !important;
      color: #fff !important;
      border-color: #1976D2;
      text-decoration: none;
      outline: none;
    }
    .feature-card .feature-action .btn-secondary {
      width: 100%;
      min-width: 0;
      font-size: 1.02rem;
      padding: 0.7rem 0;
      border-radius: 8px;
      text-align: center;
      font-weight: 700;
      text-decoration: none;
    }
    .feature-card .feature-action .btn-locked {
      background: #00E676;
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      font-weight: 700;
      border-radius: 8px;
      width: 100%;
      font-size: 1.02rem;
      padding: 0.7rem 0;
      transition: background 0.18s;
    }
    .feature-card .feature-action .btn-locked:hover,
    .feature-card .feature-action .btn-locked:focus {
      background: #00c965;
      outline: none;
    }
    .feature-card .included-badge {
      color: #00C853;
      font-size: 0.98rem;
      font-weight: 600;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .feature-card .included-badge svg {
      vertical-align: middle;
    }
    @media (max-width: 700px) {
      .dashboard-banner, .dashboard-features {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      .dashboard-banner {
        max-width: 98vw;
      }
      .dashboard-features {
        grid-template-columns: 1fr;
      }
    }
    .ats-score-row {
      display: flex;
      align-items: center;
      gap: 1.1rem;
      margin: 0.5rem 0 0.2rem 0;
    }
    .ats-donut {
      width: 54px;
      height: 54px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ats-donut svg {
      width: 54px;
      height: 54px;
      transform: rotate(-90deg);
    }
    .ats-donut .ats-score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.1rem;
      font-weight: 700;
      color: #111;
      text-align: center;
      letter-spacing: 0.5px;
    }
    .ats-score-details {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .ats-score-details .ats-score-label {
      font-size: 1.05rem;
      font-weight: 700;
      color: #232B36;
      margin-bottom: 0.1rem;
    }
    .ats-score-details .ats-score-summary {
      font-size: 1rem;
      color: #4B5563;
      max-width: 340px;
    }
    .user-plan-status {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1.2rem;
      gap: 0.3rem;
    }
    .user-plan-label {
      font-size: 0.92rem;
      color: #6B7280;
      font-weight: 500;
      margin-bottom: 0.1rem;
      letter-spacing: 0.01em;
    }
    .user-plan-badge {
      font-size: 1.02rem;
      font-weight: 600;
      border-radius: 12px;
      padding: 0.5rem 1.1rem 0.5rem 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4em;
      background: #FFF7E6;
      color: #FF9100;
      box-shadow: 0 1px 4px rgba(31,41,55,0.06);
    }
    .user-plan-badge.trial {
      color: #FF9100;
      background: #FFF7E6;
    }
    .user-plan-badge.essential {
      color: #0077B5;
      background: #E3F2FD;
    }
    .user-plan-badge.pro {
      color: #388E3C;
      background: #E8F5E9;
    }
    .user-plan-badge.premium {
      color: #C62828;
      background: #FFEBEE;
    }
    .user-plan-icon {
      width: 1.1em;
      height: 1.1em;
      vertical-align: middle;
    }
    .dashboard-banner .upgrade-btn {
      width: 100%;
      margin-top: 0.2rem;
    }
    .dashboard-banner-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 1rem;
      width: 100%;
      margin-top: 1.2rem;
      padding-top: 0.7rem;
      border-top: 1px solid #F3F4F6;
    }
    .user-plan-badge {
      font-size: 1.05rem;
      font-weight: 700;
      border-radius: 999px;
      padding: 0.22rem 1.1rem 0.22rem 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4em;
      background: #FFF7E6;
      color: #FF9100;
      box-shadow: 0 1px 4px rgba(31,41,55,0.06);
    }
    .user-plan-badge.essential {
      color: #0077B5;
      background: #E3F2FD;
    }
    .user-plan-badge.pro {
      color: #388E3C;
      background: #E8F5E9;
    }
    .user-plan-badge.premium {
      color: #C62828;
      background: #FFEBEE;
    }
    .user-plan-icon {
      width: 1.1em;
      height: 1.1em;
      vertical-align: middle;
    }
    .dashboard-banner-footer .upgrade-btn {
      background: #00E676;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1.2rem;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background 0.18s;
      text-decoration: none;
      min-width: unset;
      width: auto;
      margin-top: 0;
    }
    .dashboard-banner-footer .upgrade-btn:hover,
    .dashboard-banner-footer .upgrade-btn:focus {
      background: #00c965;
    }
    .status-action-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      gap: 0.7rem;
      margin-top: 0.5rem;
      width: 100%;
    }
    .user-plan-badge {
      display: flex;
      align-items: center;
      gap: 0.4em;
      background: #FFF7E6;
      color: #FF9100;
      font-weight: 600;
      border-radius: 999px;
      padding: 0.4rem 1.1rem;
      font-size: 1.01rem;
      box-shadow: 0 1px 4px rgba(31,41,55,0.06);
    }
    .status-action-row .upgrade-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #1976D2;
      color: #fff;
      border: none;
      font-weight: 600;
      border-radius: 12px;
      padding: 0.6rem 1.5rem;
      font-size: 1.02rem;
      min-width: 0;
      box-shadow: 0 1px 4px rgba(31,41,55,0.06);
      transition: background 0.18s, color 0.18s, border-color 0.18s;
      text-decoration: none;
      margin-top: 0;
      width: auto;
    }
    .status-action-row .upgrade-btn:hover,
    .status-action-row .upgrade-btn:focus {
      background: #125bb5;
      color: #fff;
    }
    .jh-tooltip-trigger {
      cursor: pointer;
      margin-left: 0.4em;
      vertical-align: middle;
      position: relative;
      display: inline-block;
    }
    .jh-tooltip-text {
      display: none;
      position: absolute;
      z-index: 1000;
      padding: 0.5rem 0.8rem;
      background-color: #333;
      color: #fff;
      border-radius: 4px;
      top: 120%;
      left: 50%;
      transform: translateX(-50%);
      min-width: 180px;
      max-width: 260px;
      white-space: normal;
      word-break: break-word;
      font-size: 0.98rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      pointer-events: none;
      text-align: left;
    }
    .jh-tooltip-trigger:hover .jh-tooltip-text,
    .jh-tooltip-trigger:focus .jh-tooltip-text,
    .jh-tooltip-trigger:focus-visible .jh-tooltip-text {
      display: block;
      pointer-events: auto;
    }
    .feature-card .feature-action .usage-indicator {
      flex-basis: 100%;
      margin-top: 0.45rem;
      color: #6B7280;
      line-height: 1.35;
      font-size: 0.95rem;
    }
    /* Upgrade Pop-up Modal Styles */
    .upgrade-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .upgrade-popup-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .upgrade-popup-modal {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(31, 41, 55, 0.2);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
      transform: scale(0.9) translateY(20px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .upgrade-popup-overlay.show .upgrade-popup-modal {
      transform: scale(1) translateY(0);
      opacity: 1;
    }
    .upgrade-popup-modal .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #6B7280;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
      transition: color 0.18s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .upgrade-popup-modal .close-btn:hover {
      color: #232B36;
      background: #F3F4F6;
    }
    .upgrade-popup-modal h2 {
      font-size: 1.5rem;
      font-weight: 800;
      color: #232B36;
      margin: 0 0 1rem 0;
      padding-right: 2rem;
    }
    .upgrade-popup-modal .popup-message {
      background: #E6F7FF;
      color: #1976D2;
      padding: 1em 1.2em;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      font-size: 1.01rem;
      line-height: 1.5;
    }
    .upgrade-popup-modal .popup-content {
      color: #4B5563;
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }
    .upgrade-popup-modal .popup-ok-btn {
      background: #00E676;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 0.75rem 2rem;
      font-size: 1.02rem;
      cursor: pointer;
      transition: background 0.18s;
      width: 100%;
      margin-top: 0.5rem;
    }
    .upgrade-popup-modal .popup-ok-btn:hover,
    .upgrade-popup-modal .popup-ok-btn:focus {
      background: #00c965;
      outline: none;
    }
    .upgrade-popup-modal .popup-cancel-btn {
      background: transparent;
      color: #6B7280;
      font-weight: 600;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      padding: 0.75rem 2rem;
      font-size: 1.02rem;
      cursor: pointer;
      transition: all 0.18s;
      width: 100%;
    }
    .upgrade-popup-modal .popup-cancel-btn:hover,
    .upgrade-popup-modal .popup-cancel-btn:focus {
      background: #F3F4F6;
      border-color: #9CA3AF;
      outline: none;
    }
    
    /* Loading skeleton */
    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-banner {
      height: 200px;
      border-radius: 16px;
      margin: 2rem auto;
      max-width: 540px;
    }
    .skeleton-card {
      height: 210px;
      border-radius: 16px;
    }
  </style>
</head>
<body>
  <!-- Header (canonical) -->
  <header class="site-header">
    <div class="container">
      <a href="index.html" class="nav-logo" aria-label="Go to homepage">
        <svg width="24" height="24" fill="none" stroke="#1F2937" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="18" height="13" rx="2"/>
          <path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
        <span>JOBHACKAI</span>
      </a>
      <div class="nav-group">
        <nav class="nav-links" role="navigation">
          <!-- Navigation will be dynamically populated by navigation.js -->
          <a href="index.html#blog">Blog</a>
        </nav>
      </div>
      <button class="mobile-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mobileNav">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </header>
  <nav class="mobile-nav" id="mobileNav">
    <!-- Mobile navigation will be dynamically populated by navigation.js -->
  </nav>
  <script>
    // Hamburger menu toggle
    const mobileToggle = document.querySelector('.mobile-toggle');
    const mobileNav = document.getElementById('mobileNav');
    if (mobileToggle && mobileNav) {
      mobileToggle.addEventListener('click', () => {
        const isOpen = mobileNav.classList.toggle('open');
        mobileToggle.setAttribute('aria-expanded', isOpen);
      });
      // Close mobile nav on link click
      document.querySelectorAll('.mobile-nav a').forEach(link => {
        link.addEventListener('click', () => {
          mobileNav.classList.remove('open');
          mobileToggle.setAttribute('aria-expanded', 'false');
        });
      });
    }
  </script>
  <!-- Main Content -->
  <main>
    <div id="dashboard-root">
      <!-- Loading skeleton while auth loads -->
      <div class="loading-skeleton skeleton-banner"></div>
      <div class="dashboard-features">
        <div class="loading-skeleton skeleton-card"></div>
        <div class="loading-skeleton skeleton-card"></div>
        <div class="loading-skeleton skeleton-card"></div>
      </div>
    </div>
  </main>
  <!-- Footer (canonical) -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-brand">
        <svg class="footer-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="18" height="13" rx="2" stroke="#1F2937" stroke-width="2"/>
          <path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2" stroke="#1F2937" stroke-width="2"/>
        </svg>
        <span class="footer-name">JOBHACKAI</span>
      </div>
      <div class="footer-legal">
        <p>¬© 2025 JobHackAI. All rights reserved.</p>
      </div>
      <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="support.html">Support</a>
        <a href="privacy.html">Privacy</a>
      </div>
    </div>
  </footer>
  <script src="js/free-account-manager.js"></script>
  <script src="js/universal-logout.js?v=20251007-2"></script>
  <script>
    // --- CROSS-TAB LOGOUT SYNC ONLY ---
    (function(){
      try {
        // Cross-tab logout sync only - removed problematic auth guard
        const ch = new BroadcastChannel('auth');
        ch.onmessage = (e) => { 
          if (e?.data?.type === 'logout') location.replace('login.html'); 
        };
      } catch(_) {}
    })();

    // --- HELPER FUNCTIONS ---
    async function getFirebaseIdToken() {
      try {
        const u = window.FirebaseAuthManager?.getCurrentUser?.();
        return u ? await u.getIdToken() : null;
      } catch (error) {
        console.warn('Could not get Firebase token:', error);
        return null;
      }
    }

    // --- ENHANCED AUTHENTICATION CHECK ---
    async function checkAuthentication() {
      console.log('üîß dashboard.html VERSION: auth-race-fix-v4 - ' + new Date().toISOString());

      // Wait for FirebaseAuthManager to be available
      let waitCount = 0;
      while (!window.FirebaseAuthManager && waitCount < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        waitCount++;
      }

      if (!window.FirebaseAuthManager) {
        console.error('‚ùå FirebaseAuthManager not available');
        window.location.href = 'login.html';
        return false;
      }

      // If localStorage indicates we're authenticated, give Firebase a moment to restore session
      try {
        const isAuthInStorage = localStorage.getItem('user-authenticated') === 'true';
        if (isAuthInStorage) {
          console.log('‚è≥ localStorage says authenticated; waiting for Firebase to restore session...');
          try { await window.FirebaseAuthManager.waitForAuthReady?.(2000); } catch (_) {}
          if (!window.FirebaseAuthManager.getCurrentUser?.()) {
            // Small extra grace period to avoid ping-pong
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        }
      } catch (_) {}

      const user = window.FirebaseAuthManager.getCurrentUser();
      if (!user || !user.email) {
        console.error('‚ùå No Firebase user available');
        window.location.href = 'login.html';
        return false;
      }

      console.log('‚úÖ Authenticated:', user.email);
      // Sync to localStorage for other components
      try {
        localStorage.setItem('user-authenticated', 'true');
        localStorage.setItem('user-email', user.email);
      } catch (_) {}

      return true;
    }

    // --- AUTHENTICATION STATE MANAGEMENT ---
    function getAuthState() {
      // Check for actual authentication (this would integrate with Firebase Auth)
      // For now, we'll use localStorage as a placeholder
      const isAuthenticated = localStorage.getItem('user-authenticated') === 'true';
      const userPlan = localStorage.getItem('user-plan') || 'free';
      
      return {
        isAuthenticated,
        userPlan: isAuthenticated ? userPlan : null
      };
    }

    // --- Initialize on load ---
    document.addEventListener('DOMContentLoaded', async function() {
      // Check authentication first
      const authOk = await checkAuthentication();
      if (!authOk) {
        return; // Stop here if not authenticated
      }
      
      // Get user data from authentication system
      const authState = getAuthState();
      
      // Clear selectedPlan when arriving from successful checkout
      const urlParams = new URLSearchParams(window.location.search);

      async function fetchBillingStatus(reason) {
        try {
          const firebaseToken = await getFirebaseIdToken();
          if (!firebaseToken) {
            console.warn(`‚ö†Ô∏è [DASHBOARD] Billing status sync skipped (${reason}): missing token`);
            return null;
          }

          const billingRes = await fetch('/api/billing-status', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${firebaseToken}` }
          });

          if (!billingRes.ok) {
            console.warn(`‚ö†Ô∏è [DASHBOARD] Billing status response not ok (${reason}):`, billingRes.status);
            return null;
          }

          const billingData = await billingRes.json();
          if (!billingData?.ok) {
            console.warn(`‚ö†Ô∏è [DASHBOARD] Billing status payload not ok (${reason})`);
            return null;
          }

          return billingData;
        } catch (e) {
          console.warn(`‚ö†Ô∏è [DASHBOARD] Billing status sync failed (${reason}):`, e);
          return null;
        }
      }

      function applyBillingData(billingData, logLabel) {
        if (!billingData) return;

        console.log(`‚úÖ [DASHBOARD] Synced plan from Stripe ${logLabel}:`, billingData.plan);
        localStorage.setItem('user-plan', billingData.plan);
        localStorage.setItem('dev-plan', billingData.plan);

        if (billingData.trialEndsAt) {
          localStorage.setItem('trial-ends-at', new Date(billingData.trialEndsAt).toISOString());
        }

        // Update navigation state
        if (window.JobHackAINavigation?.setAuthState) {
          window.JobHackAINavigation.setAuthState(true, billingData.plan);
        }
      }

      let billingStatusData = null;

      if (urlParams.get('paid') === '1') {
        console.log('‚úÖ [DASHBOARD] Cleared selectedPlan after successful checkout');
        try {
          sessionStorage.removeItem('selectedPlan');
          localStorage.removeItem('selectedPlan');
        } catch (_) {}

        billingStatusData = await fetchBillingStatus('after checkout');
        applyBillingData(billingStatusData, 'after successful checkout');
      }
      
      // Force KV plan fetch when pending or on normal dashboard load (fallback)
      if (authState.userPlan === 'pending') {
        console.log('üîÑ Forcing KV plan refresh (pending plan)');
        if (window.JobHackAINavigation?.fetchKVPlan) {
          try {
            const freshPlan = await window.JobHackAINavigation.fetchKVPlan();
            if (freshPlan) {
              console.log('‚úÖ Fetched fresh plan from KV:', freshPlan);
              localStorage.setItem('user-plan', freshPlan);
              // Force navigation update
              if (window.JobHackAINavigation?.setAuthState) {
                window.JobHackAINavigation.setAuthState(true, freshPlan);
              }
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Could not fetch plan from KV:', e);
          }
        }
      }
      
      // Also sync from billing-status on every dashboard load to ensure accuracy
      if (!billingStatusData) {
        billingStatusData = await fetchBillingStatus('on load');
        applyBillingData(billingStatusData, 'on load');
      }
      // Fallback to KV if billing-status fails is handled below when needed
      
      // Wait for navigation system to be ready
      let currentPlan = 'free';
      if (window.JobHackAINavigation && typeof window.JobHackAINavigation.getEffectivePlan === 'function') {
        currentPlan = window.JobHackAINavigation.getEffectivePlan();
        console.log('‚úÖ Got plan from navigation:', currentPlan);
      } else {
        // Fallback: try localStorage directly
        currentPlan = localStorage.getItem('user-plan') || 'free';
        console.log('‚ö†Ô∏è Navigation not ready, using localStorage plan:', currentPlan);
      }
      
      // Set flag if user upgraded from free to trial/paid plan
      // Only set flag if previous-plan actually exists (not defaulting to 'free')
      // This prevents direct paid signups from being incorrectly marked as former free users
      const previousPlan = localStorage.getItem('previous-plan');
      if (previousPlan === 'free' && (currentPlan === 'trial' || currentPlan === 'essential' || currentPlan === 'pro' || currentPlan === 'premium')) {
        localStorage.setItem('was-free-user', 'true');
        console.log('‚úÖ Marked user as former free user (upgraded to', currentPlan + ')');
      }
      // Update previous plan for next check (only if it changed)
      if (previousPlan !== currentPlan) {
        localStorage.setItem('previous-plan', currentPlan);
      }

      // If coming from Stripe with ?paid=1 but KV says 'free', force sync
      // Reuse urlParams from line 705
      if (urlParams.get('paid') === '1' && currentPlan === 'free') {
        console.log('üîÑ KV mismatch detected, forcing Stripe sync...');
        try {
          // Get Firebase ID token for authentication
          const firebaseToken = await getFirebaseIdToken();
          if (firebaseToken) {
            const syncResponse = await fetch('/api/sync-stripe-plan', {
              method: 'POST',
              headers: { 
                'Authorization': `Bearer ${firebaseToken}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (syncResponse.ok) {
              const syncData = await syncResponse.json();
              if (syncData.plan && syncData.plan !== 'free') {
                console.log('‚úÖ Sync successful, updating plan:', syncData.plan);
                currentPlan = syncData.plan;
                localStorage.setItem('user-plan', currentPlan);
                if (syncData.trialEndsAt) {
                  localStorage.setItem('trial-ends-at', syncData.trialEndsAt);
                  console.log('‚úÖ Updated trial end date:', syncData.trialEndsAt);
                }
                
                // Force navigation update with new plan
                if (window.JobHackAINavigation?.setAuthState) {
                  window.JobHackAINavigation.setAuthState(true, currentPlan);
                }
              } else {
                console.log('‚ö†Ô∏è Sync returned free plan, keeping current');
              }
            } else {
              console.warn('‚ö†Ô∏è Sync failed:', syncResponse.status);
            }
          } else {
            console.warn('‚ö†Ô∏è Could not get Firebase token for sync');
          }
        } catch (syncError) {
          console.warn('‚ö†Ô∏è Sync error:', syncError);
        }
      }

      console.log('üìä Dashboard Debug:', {
        'user-plan': localStorage.getItem('user-plan'),
        'trial-ends-at': localStorage.getItem('trial-ends-at'),
        'user-authenticated': localStorage.getItem('user-authenticated'),
        'currentPlan': currentPlan
      });
      
      // Create user object from authentication data
      let authUserName = 'User';
      let authUserEmail = 'user@example.com';
      let authUserUid = null;
      try {
        const u = window.FirebaseAuthManager?.getCurrentUser?.();
        if (u) {
          authUserEmail = u.email || authUserEmail;
          authUserUid = u.uid || null;
          const dn = u.displayName || '';
          if (dn) authUserName = dn;
        }
      } catch (_) {}
      const user = {
        name: authUserName,
        email: authUserEmail,
        uid: authUserUid,
        plan: currentPlan,
        trialEndsAt: localStorage.getItem('trial-ends-at') || new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
        hasUsedFreeTrial: true,
        hasUsedFreeATS: true
      };
      
      // Continue with existing dashboard logic
      renderDashboard(user);
    });

    // --- USER DATA INJECTION (replace with your data source, e.g. from Google Sheets or Wix Data) ---
    // Note: This is now handled in the DOMContentLoaded function above

    // --- FEATURE MATRIX ---
    const featureMatrix = {
      free:     ["ats"],
      trial:    ["ats", "feedback", "interview"],
      essential:["ats", "feedback", "interview"],
      pro:      ["ats", "feedback", "interview", "rewriting", "coverLetter", "mockInterview"],
      premium:  ["ats", "feedback", "interview", "rewriting", "coverLetter", "mockInterview", "linkedin", "priorityReview"]
    };
    // --- FEATURE DEFINITIONS ---
    const features = [
      {
        key: "ats",
        title: "ATS Resume Score",
        desc: "Receive an overall ATS compliance score for your resume, highlighting key areas to improve.",
        action: "Upload PDF",
        included: true
      },
      {
        key: "feedback",
        title: "Resume Feedback",
        desc: "Get a detailed analysis of what's working and what could be improved across every section of your resume.",
        action: "Upgrade to Unlock",
        included: true
      },
      {
        key: "interview",
        title: "Interview Questions",
        desc: "Receive a curated set of practice interview questions tailored to your target role.",
        action: "Start Practice",
        included: true
      },
      {
        key: "rewriting",
        title: "Resume Rewriting",
        desc: "See a rewritten version of your resume tailored to your target job ‚Äì ready to copy and paste.",
        action: "Upgrade to Unlock",
        included: false
      },
      {
        key: "coverLetter",
        title: "Cover Letter Generator",
        desc: "Generate an ATS-optimized, job-specific cover letter in a confident, professional tone.",
        action: "Upgrade to Unlock",
        included: false
      },
      {
        key: "mockInterview",
        title: "Mock Interviews",
        desc: "Practice real-time mock interviews with AI feedback to refine your answers and delivery.",
        action: "Upgrade to Unlock",
        included: false
      },
      {
        key: "linkedin",
        title: "LinkedIn Optimizer",
        desc: "Optimize your LinkedIn profile section-by-section for maximum recruiter visibility.",
        action: "Upgrade to Unlock",
        included: false
      },
      {
        key: "priorityReview",
        title: "Priority Review",
        desc: "Get your documents reviewed by our AI with expedited turnaround.",
        action: "Upgrade to Unlock",
        included: false
      }
    ];
    // --- RENDER LOGIC ---
    function daysLeft(trialEndsAt) {
      const now = new Date();
      const end = new Date(trialEndsAt);
      const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
      return diff > 0 ? diff : 0;
    }

    // Fetch subscription status for warning banners
    async function fetchSubscriptionStatus() {
      try {
        const user = window.FirebaseAuthManager?.getCurrentUser?.();
        if (!user) return null;
        
        const idToken = await user.getIdToken();
        const res = await fetch('/api/plan/me', {
          headers: { Authorization: `Bearer ${idToken}` }
        });
        
        if (!res.ok) return null;
        return await res.json();
      } catch (e) {
        console.warn('Failed to fetch subscription status:', e);
        return null;
      }
    }
    // Example ATS score (replace with real value from backend or Google Sheets)
    const atsScore = {
      percent: 78, // 0-100
      value: 78,
      max: 100,
      summary: "Your resume meets many ATS criteria and is likely to be noticed."
    };
    async function renderDashboard(user) {
      const root = document.getElementById('dashboard-root');
      const unlocked = featureMatrix[user.plan] || [];
      
      // Fetch subscription status for warning banners
      const subStatus = await fetchSubscriptionStatus();
      // ATS Donut SVG (green ring, black text)
      function atsDonut(percent) {
        const radius = 23;
        const stroke = 3;
        const norm = 2 * Math.PI * radius;
        const progress = (percent / 100) * norm;
        return `
          <div class="ats-donut" aria-label="ATS Score">
            <svg viewBox="0 0 54 54">
              <circle cx="27" cy="27" r="${radius}" stroke="#E5E7EB" stroke-width="${stroke}" fill="none"/>
              <circle cx="27" cy="27" r="${radius}" stroke="#00E676" stroke-width="${stroke}" fill="none" stroke-dasharray="${norm}" stroke-dashoffset="${norm - progress}" stroke-linecap="round"/>
            </svg>
            <span class="ats-score-text">${percent}%</span>
          </div>
        `;
      }
      // Banner
      function planIcon(plan) {
        switch (plan) {
          case 'trial':
            return `<svg class="user-plan-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#FF9100" opacity="0.12"/><path d="M10 4v7l4 2" stroke="#FF9100" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          case 'essential':
            return `<svg class="user-plan-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#0077B5" opacity="0.12"/><path d="M10 5v10M5 10h10" stroke="#0077B5" stroke-width="1.5" stroke-linecap="round"/></svg>`;
          case 'pro':
            return `<svg class="user-plan-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#388E3C" opacity="0.12"/><path d="M6 10l3 3 5-5" stroke="#388E3C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          case 'premium':
            return `<svg class="user-plan-icon" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="10" fill="#C62828" opacity="0.12"/><path d="M10 5l2.09 4.26L17 9.27l-3.45 3.36L14.18 17 10 14.27 5.82 17l0.63-4.37L3 9.27l4.91-0.01L10 5z" stroke="#C62828" stroke-width="1.2" fill="none"/></svg>`;
          default:
            return '';
        }
      }
      let banner = `<div class="dashboard-banner">
        <a href="#" class="settings-link" aria-label="Account Settings">
          <svg width="20" height="20" fill="none" stroke="#6B7280" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3.2"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06A1.65 1.65 0 0015 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 008.6 15a1.65 1.65 0 00-1.82-.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.6 8.6a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 008.6 4.6a1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0015 4.6a1.65 1.65 0 001.82.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 8.6a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06A1.65 1.65 0 0015 15a1.65 1.65 0 001.82.33z"/></svg>
        </a>
        <div class="welcome-row">
          <h2>Welcome back, ${user.name || 'User'}!</h2>
          ${user.plan === 'trial' ? `<div class="trial-countdown">You have ${daysLeft(user.trialEndsAt)} day${daysLeft(user.trialEndsAt) !== 1 ? 's' : ''} left in your trial!</div>` : ''}
          ${subStatus && subStatus.cancelAt ? `
            <div style="background:#FEF3C7;border-left:4px solid #F59E0B;color:#92400E;padding:0.8rem 1rem;border-radius:8px;margin:0.5rem 0;font-size:0.98rem;">
              ‚ö†Ô∏è <strong>Your subscription will be canceled on ${new Date(subStatus.cancelAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}.</strong> You'll have access until then.
              <a href="#" onclick="openBillingPortal(event)" style="color:#92400E;text-decoration:underline;margin-left:0.5rem;">Manage subscription</a>
            </div>
          ` : ''}
          ${subStatus && subStatus.scheduledPlanChange ? `
            <div style="background:#DBEAFE;border-left:4px solid #3B82F6;color:#1E40AF;padding:0.8rem 1rem;border-radius:8px;margin:0.5rem 0;font-size:0.98rem;">
              ‚ÑπÔ∏è <strong>Your plan will change to ${subStatus.scheduledPlanChange.newPlan.charAt(0).toUpperCase() + subStatus.scheduledPlanChange.newPlan.slice(1)} on ${new Date(subStatus.scheduledPlanChange.effectiveDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}.</strong>
              <a href="#" onclick="openBillingPortal(event)" style="color:#1E40AF;text-decoration:underline;margin-left:0.5rem;">View details</a>
            </div>
          ` : ''}
          ${subStatus && subStatus.currentPeriodEnd && user.plan !== 'free' && !subStatus.cancelAt && !subStatus.scheduledPlanChange ? `
            <div style="color:#6B7280;font-size:0.92rem;margin:0.3rem 0;">
              Renews on ${new Date(subStatus.currentPeriodEnd).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
            </div>
          ` : ''}
          <div class="user-email">${user.email}</div>
        </div>
        <div class="ats-score-row">
          ${atsDonut(atsScore.percent)}
          <div class="ats-score-details">
            <span class="ats-score-label">${atsScore.value} / ${atsScore.max}</span>
            <span class="ats-score-summary">${atsScore.summary}</span>
          </div>
        </div>
        <div class="status-action-row">
          <span class="user-plan-badge ${user.plan}">${planIcon(user.plan)}${user.plan === 'trial' && user.trialEndsAt ? `Trial (${daysLeft(user.trialEndsAt)} days left)` : user.plan.charAt(0).toUpperCase() + user.plan.slice(1)}</span>
          ${(user.plan === 'cancelled') ? `<a href="pricing-a.html" class="upgrade-btn">Reactivate</a>` : ''}
        </div>
      </div>`;
      // Always load last ATS score/result from localStorage if present
      let lastScore = localStorage.getItem('lastATSScore');
      let lastSummary = localStorage.getItem('lastATSSummary');
      if (lastScore && lastSummary) {
        atsScore.value = parseInt(lastScore, 10);
        atsScore.percent = parseInt(lastScore, 10);
        atsScore.summary = lastSummary;
      }
      // Features
      let featuresHtml = '<div class="dashboard-features">';
      // Always render ATS Scoring first
      const atsFeature = features.find(f => f.key === 'ats');
      const otherFeatures = features.filter(f => f.key !== 'ats');
      const orderedFeatures = [atsFeature, ...otherFeatures];
      for (const feature of orderedFeatures) {
        const isUnlocked = unlocked.includes(feature.key);
        featuresHtml += `<div class="feature-card${isUnlocked ? '' : ' locked'}">`;
        featuresHtml += `<div class="feature-title">${feature.title}</div>`;
        featuresHtml += `<div class="feature-desc">${feature.desc}</div>`;
        featuresHtml += `<div class="feature-action">`;
        if (isUnlocked && feature.key === 'ats') {
          // ATS Scoring: real upload
          featuresHtml += `<input type=\"file\" id=\"ats-upload-input\" accept=\"application/pdf\" style=\"display:none;\" />`;
          featuresHtml += `<button class=\"btn-primary\" id=\"ats-upload-btn\">${feature.action}</button>`;
          let usageText = '';
          let tooltip = '';
          if (user.plan === 'free') {
            // Check lifetime credit
            const creditKey = `creditsByUid:${user.uid}`;
            const creditsData = localStorage.getItem(creditKey);
            const credits = creditsData ? JSON.parse(creditsData) : { ats_free_lifetime: 1 };
            
            if (credits.ats_free_lifetime > 0) {
              usageText = 'You have 1 free ATS score (lifetime).';
              tooltip = `<span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg>
                <span class="jh-tooltip-text">This is a one-time free score. After use, upgrade for unlimited ATS scoring.</span>
              </span>`;
            } else {
              usageText = 'Free ATS score used. Upgrade for unlimited scoring.';
            }
          } else if (user.plan === 'trial') {
            usageText = 'Unlimited ATS resume scoring during your trial.';
            tooltip = `<span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg>
              <span class="jh-tooltip-text">You have unlimited ATS resume scoring during your trial.</span>
            </span>`;
          }
          featuresHtml += `<div class="usage-indicator">${usageText}${tooltip}</div>`;
        } else if (isUnlocked && feature.key === 'feedback') {
          // Resume Feedback: link to feedback page (unlocked for trial, essential, pro, premium)
          featuresHtml += `<a href=\"resume-feedback-pro.html\" class=\"btn-primary\">Get Detailed Feedback</a>`;
          let usageText = '';
          let tooltip = '';
          if (user.plan === 'trial') {
            usageText = '3 feedbacks remaining in your trial.';
            tooltip = `<span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg>
              <span class="jh-tooltip-text">You can get up to 3 detailed feedbacks during your trial. Upgrade to Pro for unlimited feedback.</span>
            </span>`;
          } else if (user.plan === 'essential') {
            // For demo, assume 3 left (replace with dynamic count if available)
            usageText = '3 resume feedbacks left this month.';
            tooltip = `<span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg>
              <span class="jh-tooltip-text">Upgrade to Pro for unlimited feedback.</span>
            </span>`;
          }
          featuresHtml += `<div class="usage-indicator">${usageText}${tooltip}</div>`;
        } else if (isUnlocked && feature.key === 'interview') {
          // Interview Questions: link to interview questions page (unlocked for trial, essential, pro, premium)
          featuresHtml += `<a href=\"interview-questions.html\" class=\"btn-primary\">${feature.action}</a>`;
          let usageText = '';
          let tooltip = '';
          if (user.plan === 'trial') {
            usageText = 'Unlimited interview questions during your trial.';
            tooltip = `<span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg>
              <span class="jh-tooltip-text">Practice as much as you want during your trial.</span>
            </span>`;
          }
          featuresHtml += `<div class="usage-indicator">${usageText}${tooltip}</div>`;
        } else if (isUnlocked && feature.key === 'rewriting') {
          // Resume Rewriting: link for Pro and Premium
          featuresHtml += `<a href="resume-feedback-pro.html#rewrite" class="btn-primary">Start Rewriting</a>`;
          if (user.plan === 'pro') {
            featuresHtml += `<div class="usage-indicator">Unlimited with your Pro plan. <span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg><span class="jh-tooltip-text">Unlimited with your Pro plan.</span></span></div>`;
          }
        } else if (isUnlocked && feature.key === 'coverLetter') {
          // Cover Letter Generator: link for Pro and Premium
          featuresHtml += `<a href="cover-letter-generator.html" class="btn-primary">Generate Cover Letter</a>`;
          if (user.plan === 'pro') {
            featuresHtml += `<div class="usage-indicator">Unlimited with your Pro plan. <span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg><span class="jh-tooltip-text">Unlimited with your Pro plan.</span></span></div>`;
          }
        } else if (isUnlocked && feature.key === 'mockInterview') {
          // Mock Interviews: link for Pro and Premium
          featuresHtml += `<a href="mock-interview.html" class="btn-primary">Start Mock Interview</a>`;
          if (user.plan === 'pro') {
            featuresHtml += `<div class="usage-indicator">20 mock interviews left this month. <span class="jh-tooltip-trigger" tabindex="0" aria-label="More info" style="margin-left:0.4em;vertical-align:middle;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" style="vertical-align:middle"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="8"/><line x1="12" y1="12" x2="12" y2="16"/></svg><span class="jh-tooltip-text">Upgrade to Premium for unlimited mock interviews.</span></span></div>`;
          }
        } else if (isUnlocked && feature.key === 'linkedin') {
          // LinkedIn Optimizer: link for Premium
          featuresHtml += `<a href=\"linkedin-optimizer.html\" class=\"btn-primary\">Optimize LinkedIn</a>`;
        } else if (isUnlocked && feature.key === 'priorityReview') {
          // Priority Review: icon and text for Premium
          featuresHtml += `<div style=\"display:flex;align-items:center;gap:0.6rem;margin:0.7rem 0 0.2rem 0;\"><svg width=\"22\" height=\"22\" fill=\"none\" stroke=\"#00E676\" stroke-width=\"2\" viewBox=\"0 0 24 24\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M12 8v4l2.5 2.5\"/></svg><span style=\"font-weight:600;color:#00C853;\">All your AI-generated content will get priority review.</span></div>`;
        } else {
          featuresHtml += `<button class=\"btn-locked\" data-feature-key=\"${feature.key}\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#fff\" stroke-width=\"2\"><rect x=\"3\" y=\"11\" width=\"18\" height=\"8\" rx=\"2\"/><path d=\"M7 11V7a5 5 0 0110 0v4\"/></svg> ${feature.action}</button>`;
        }
        featuresHtml += `</div>`;
        if (isUnlocked && (user.plan === 'trial' || user.plan === 'essential' || user.plan === 'pro' || user.plan === 'premium')) {
          featuresHtml += `<div class="included-badge"><svg width="16" height="16" fill="#00C853" viewBox="0 0 24 24"><path d="M20.285 6.709a1 1 0 00-1.414-1.418l-9.192 9.192-4.242-4.242a1 1 0 00-1.414 1.414l4.949 4.95a1 1 0 001.414 0l9.899-9.896z"/></svg> Included in ${user.plan === 'trial' ? 'Trial' : user.plan.charAt(0).toUpperCase() + user.plan.slice(1)}</div>`;
        }
        featuresHtml += `</div>`;
      }
      featuresHtml += '</div>';
      root.innerHTML = banner + featuresHtml;
      
      // --- Upgrade Pop-up Logic ---
      function showUpgradePopup() {
        // Check if popup was already shown
        const popupShownKey = 'upgrade-popup-shown';
        if (localStorage.getItem(popupShownKey) === 'true') {
          return;
        }
        
        // Check if user upgraded from free to trial/subscription
        const hasUpgradedPlan = user.plan === 'trial' || user.plan === 'essential' || user.plan === 'pro' || user.plan === 'premium';
        if (!hasUpgradedPlan) {
          return;
        }
        
        // Check if user had uploaded a resume for free ATS scoring
        // Check multiple indicators that user had a free account with resume upload
        const hasATSScoreHistory = localStorage.getItem('lastATSScore') || localStorage.getItem('lastATSSummary');
        const hasUsedFreeATS = localStorage.getItem('hasUsedFreeATS') === 'true';
        const hasFreeUsageData = localStorage.getItem('free-ats-usage');
        const hasUploadedResume = localStorage.getItem('lastUploadedResume') || localStorage.getItem('hasUploadedResume') === 'true';
        
        // Try to get user UID from Firebase Auth Manager
        const currentUser = window.FirebaseAuthManager?.getCurrentUser?.();
        const creditKey = currentUser?.uid ? `creditsByUid:${currentUser.uid}` : null;
        let hasUsedFreeCredit = false;
        let hadFreeAccountWithCredit = false; // Track if user had free account (credit was initialized)
        if (creditKey) {
          const creditsData = localStorage.getItem(creditKey);
          if (creditsData) {
            try {
              const credits = JSON.parse(creditsData);
              // User has used free credit if it's 0 (they had it and used it)
              hasUsedFreeCredit = credits.ats_free_lifetime === 0;
              // If creditsData exists, user had a free account (credit was initialized)
              // Credit value of 1 means they had free account but haven't used it yet
              // Credit value of 0 means they had free account and used it
              hadFreeAccountWithCredit = true;
            } catch (e) {
              // Ignore parse errors
            }
          }
        }
        
        // Check if user was previously on free plan (stored when they upgrade)
        const wasFreeUser = localStorage.getItem('was-free-user') === 'true';
        
        // Check if user has any ATS score history (even if they didn't use free credit)
        // This covers the case where they upgraded before using their free credit
        const hasAnyATSScore = hasATSScoreHistory || hasUploadedResume;
        
        // Show popup if user upgraded from free plan
        // Check if they were previously on free (either via flag or by checking if they have free account indicators)
        // Also show if they have any ATS score history (carryover scenario)
        // Only consider creditKey condition if creditsData actually exists (proving they had a free account)
        const wasFreeAccount = wasFreeUser || 
                               hasFreeUsageData || 
                               (hadFreeAccountWithCredit && !hasUsedFreeCredit); // Had free account credit initialized but hasn't used it yet
        
        // Show popup only if:
        // 1. User was previously on free account (verified via flag or indicators), OR
        // 2. User has ATS score history (carryover scenario)
        // Do NOT show to users who signed up directly for paid plans without ever having free accounts
        const shouldShowPopup = wasFreeAccount || hasATSScoreHistory || hasUploadedResume || hasAnyATSScore;
        if (!shouldShowPopup) {
          return;
        }
        
        // Create and show popup
        const popupHTML = `
          <div class="upgrade-popup-overlay" id="upgrade-popup-overlay">
            <div class="upgrade-popup-modal">
              <button class="close-btn" id="upgrade-popup-close" aria-label="Close">√ó</button>
              <h2>Welcome back, ${user.name || 'User'}!</h2>
              <div class="popup-message">
                Your previous ATS resume score has been carried over from your free account. You now have access to more features and unlimited scoring!
              </div>
              <div class="popup-content">
                <p>You can now upload unlimited resumes for ATS scoring and access additional features like detailed resume feedback and interview question generation.</p>
              </div>
              <button class="popup-ok-btn" id="upgrade-popup-ok">OK</button>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', popupHTML);
        const overlay = document.getElementById('upgrade-popup-overlay');
        const closeBtn = document.getElementById('upgrade-popup-close');
        const okBtn = document.getElementById('upgrade-popup-ok');
        
        // Escape key handler - stored so it can be removed later
        const escapeKeyHandler = function(e) {
          if (e.key === 'Escape' && overlay.classList.contains('show')) {
            closePopup();
          }
        };
        
        function closePopup() {
          overlay.classList.remove('show');
          // Remove Escape key listener to prevent memory leak
          document.removeEventListener('keydown', escapeKeyHandler);
          setTimeout(() => {
            overlay.remove();
            localStorage.setItem(popupShownKey, 'true');
          }, 300);
        }
        
        // Show popup with fade-in animation
        setTimeout(() => {
          overlay.classList.add('show');
        }, 100);
        
        // Close handlers
        closeBtn.addEventListener('click', closePopup);
        okBtn.addEventListener('click', closePopup);
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closePopup();
          }
        });
        
        // Close on Escape key
        document.addEventListener('keydown', escapeKeyHandler);
      }
      
      // Show popup after a short delay to ensure page is rendered
      setTimeout(() => {
        showUpgradePopup();
      }, 500);
      
      // --- Free Account Upgrade CTA Pop-up Logic ---
      function showFreeAccountUpgradePopup() {
        // Create and show popup
        const popupHTML = `
          <div class="upgrade-popup-overlay" id="free-account-upgrade-popup-overlay">
            <div class="upgrade-popup-modal">
              <button class="close-btn" id="free-account-upgrade-popup-close" aria-label="Close">√ó</button>
              <h2>Upgrade to Continue</h2>
              <div class="popup-message">
                You've used your 1 free lifetime ATS resume score. Upgrade to unlock unlimited scoring and access all features!
              </div>
              <div class="popup-content">
                <p style="margin-bottom: 1rem; font-weight: 600; color: #232B36;">With a subscription, you'll get:</p>
                <ul style="list-style: none; padding: 0; margin: 0 0 1.5rem 0;">
                  <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00E676" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 6L9 17l-5-5"/>
                    </svg>
                    <span>Unlimited ATS resume scoring</span>
                  </li>
                  <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00E676" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 6L9 17l-5-5"/>
                    </svg>
                    <span>Detailed resume feedback</span>
                  </li>
                  <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00E676" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 6L9 17l-5-5"/>
                    </svg>
                    <span>Interview question generator</span>
                  </li>
                  <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00E676" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 6L9 17l-5-5"/>
                    </svg>
                    <span>Priority support</span>
                  </li>
                </ul>
              </div>
              <button class="popup-ok-btn" id="free-account-upgrade-popup-cta" style="margin-bottom: 0.5rem;">View Pricing Plans</button>
              <button class="popup-cancel-btn" id="free-account-upgrade-popup-cancel" style="background: transparent; color: #6B7280; border: 1px solid #D1D5DB; margin-top: 0;">Maybe Later</button>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', popupHTML);
        const overlay = document.getElementById('free-account-upgrade-popup-overlay');
        const closeBtn = document.getElementById('free-account-upgrade-popup-close');
        const ctaBtn = document.getElementById('free-account-upgrade-popup-cta');
        const cancelBtn = document.getElementById('free-account-upgrade-popup-cancel');
        
        // Escape key handler - stored so it can be removed later
        const escapeKeyHandler = function(e) {
          if (e.key === 'Escape' && overlay.classList.contains('show')) {
            closePopup();
          }
        };
        
        function closePopup() {
          overlay.classList.remove('show');
          // Remove Escape key listener to prevent memory leak
          document.removeEventListener('keydown', escapeKeyHandler);
          setTimeout(() => {
            overlay.remove();
          }, 300);
        }
        
        // Show popup with fade-in animation
        setTimeout(() => {
          overlay.classList.add('show');
        }, 100);
        
        // CTA button - redirect to pricing
        ctaBtn.addEventListener('click', () => {
          window.location.href = 'pricing-a.html';
        });
        
        // Close handlers
        closeBtn.addEventListener('click', closePopup);
        cancelBtn.addEventListener('click', closePopup);
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            closePopup();
          }
        });
        
        // Close on Escape key
        document.addEventListener('keydown', escapeKeyHandler);
      }
      
      // --- ATS Upload Button Logic ---
      const atsUploadBtn = document.getElementById('ats-upload-btn');
      const atsUploadInput = document.getElementById('ats-upload-input');
      if (atsUploadBtn && atsUploadInput) {
        atsUploadBtn.addEventListener('click', async function() {
          const user = window.FirebaseAuthManager?.getCurrentUser?.();
          if (!user) {
            alert('Please log in to use ATS scoring');
            return;
          }
          
          // Fetch current plan and check if user has unlimited access
          const idToken = await user.getIdToken();
          const planRes = await fetch('/api/plan/me', {
            headers: { Authorization: `Bearer ${idToken}` }
          });
          const planData = await planRes.json();
          const plan = planData.plan || localStorage.getItem('user-plan') || 'free';
          
          // Trial and subscription plans have unlimited ATS scoring - skip credit check
          const hasUnlimitedAccess = plan === 'trial' || plan === 'essential' || plan === 'pro' || plan === 'premium';
          
          // Only check credits for free users - do NOT show alert for trial/paid users
          if (!hasUnlimitedAccess && plan === 'free') {
            const creditKey = `creditsByUid:${user.uid}`;
            const creditsData = localStorage.getItem(creditKey);
            let hasCredit = false;
            
            if (creditsData) {
              try {
                const credits = JSON.parse(creditsData);
                hasCredit = credits.ats_free_lifetime > 0;
              } catch (e) {
                // Ignore parse errors, default to allowing (new user)
                console.warn('Failed to parse credits data:', e);
                hasCredit = true;
              }
            } else {
              // No credits data means user hasn't used it yet - they have 1 free credit
              hasCredit = true;
            }
            
            if (!hasCredit) {
              // Show CTA pop-up instead of alert
              showFreeAccountUpgradePopup();
              return;
            }
          }
          
          // Trigger file input
          atsUploadInput.click();
        });
        
        atsUploadInput.addEventListener('change', async function(e) {
          const file = e.target.files[0];
          if (!file) return;

          // Check free account usage limits - skip for trial/subscription users
          const currentUser = window.FirebaseAuthManager?.getCurrentUser?.();
          let userPlan = localStorage.getItem('user-plan') || 'free';
          
          // Try to get fresh plan data
          if (currentUser) {
            try {
              const idToken = await currentUser.getIdToken();
              const planRes = await fetch('/api/plan/me', {
                headers: { Authorization: `Bearer ${idToken}` }
              });
              if (planRes.ok) {
                const planData = await planRes.json();
                userPlan = planData.plan || userPlan;
              }
            } catch (error) {
              console.error('Error fetching plan:', error);
            }
          }
          
          const hasUnlimitedAccess = userPlan === 'trial' || userPlan === 'essential' || userPlan === 'pro' || userPlan === 'premium';
          
          // Only check free account limits for free users - do NOT show alert for trial/paid users
          if (!hasUnlimitedAccess && userPlan === 'free') {
            // Check lifetime credit first
            const currentUser = window.FirebaseAuthManager?.getCurrentUser?.();
            let hasCredit = false;
            if (currentUser && currentUser.uid) {
              const creditKey = `creditsByUid:${currentUser.uid}`;
              const creditsData = localStorage.getItem(creditKey);
              if (creditsData) {
                try {
                  const credits = JSON.parse(creditsData);
                  hasCredit = credits.ats_free_lifetime > 0;
                } catch (e) {
                  // Ignore parse errors, default to allowing (new user or corrupted data)
                  console.warn('Failed to parse credits data:', e);
                  hasCredit = true;
                }
              } else {
                // No credits data means user hasn't used it yet
                hasCredit = true;
              }
            }
            
            // Also check freeAccountManager as fallback
            if (!hasCredit && window.freeAccountManager) {
              const usageCheck = window.freeAccountManager.canUseATSScoring();
              hasCredit = usageCheck.allowed;
            }
            
            if (!hasCredit) {
              // Show CTA pop-up instead of alert
              showFreeAccountUpgradePopup();
              // Reset file input
              e.target.value = '';
              return;
            }
          }

          // Store last uploaded resume in localStorage for use on Resume Feedback page
          const reader = new FileReader();
          reader.onload = function(evt) {
            // Store as base64 string (for demo; in production, use backend or secure storage)
            localStorage.setItem('lastUploadedResume', evt.target.result);
            // Optionally, store file name
            localStorage.setItem('lastUploadedResumeName', file.name);
            // Mark that user has uploaded a resume (for upgrade popup detection)
            localStorage.setItem('hasUploadedResume', 'true');
          };
          reader.readAsDataURL(file);
          
          // Store score for upgrade popup detection
          const score = Math.floor(Math.random() * 31) + 60; // 60-90%
          const summary = score > 85 ? 'Excellent! Your resume is highly ATS compatible.' : score > 70 ? 'Your resume meets many ATS criteria and is likely to be noticed.' : 'Your resume needs improvement for better ATS results.';
          localStorage.setItem('lastATSScore', score.toString());
          localStorage.setItem('lastATSSummary', summary);

          // Record usage for free accounts only (trial/subscription users have unlimited)
          if (!hasUnlimitedAccess && userPlan === 'free' && window.freeAccountManager) {
            const usageResult = window.freeAccountManager.recordATSUsage();
            if (!usageResult.success) {
              alert(usageResult.message);
              return;
            }
          }
          
          // Consume credit for free users only (trial/subscription users have unlimited)
          const user = window.FirebaseAuthManager?.getCurrentUser?.();
          if (user) {
            const idToken = await user.getIdToken();
            const planRes = await fetch('/api/plan/me', {
              headers: { Authorization: `Bearer ${idToken}` }
            });
            const planData = await planRes.json();
            const plan = planData.plan || localStorage.getItem('user-plan') || 'free';
            const hasUnlimitedAccess = plan === 'trial' || plan === 'essential' || plan === 'pro' || plan === 'premium';
            
            // Only consume credits for free users
            if (!hasUnlimitedAccess && plan === 'free') {
              const creditKey = `creditsByUid:${user.uid}`;
              const creditsData = localStorage.getItem(creditKey);
              let credits = { ats_free_lifetime: 1 }; // Default for new users
              
              if (creditsData) {
                try {
                  credits = JSON.parse(creditsData);
                } catch (e) {
                  // Handle corrupted JSON - default to consumed state (0) since validation already passed
                  console.warn('Failed to parse credits data during consumption, defaulting to consumed:', e);
                  credits = { ats_free_lifetime: 0 };
                }
              }
              
              // Consume credit
              credits.ats_free_lifetime = 0;
              localStorage.setItem(creditKey, JSON.stringify(credits));
              console.log('‚úÖ Free ATS credit consumed');
              
              // Update UI to show credit used
              const usageDiv = document.querySelector('.feature-card:has(#ats-upload-btn) .usage-indicator');
              if (usageDiv) {
                usageDiv.innerHTML = 'Free ATS score used. <a href="pricing-a.html" style="color:#0077B5;text-decoration:underline;">Upgrade for unlimited</a>';
              }
            }
          }
          // Update donut
          const donut = document.querySelector('.ats-donut');
          if (donut) {
            const radius = 23;
            const norm = 2 * Math.PI * radius;
            const progress = (score / 100) * norm;
            const svg = donut.querySelector('svg');
            if (svg) {
              const circles = svg.querySelectorAll('circle');
              if (circles[1]) circles[1].setAttribute('stroke-dashoffset', (norm - progress));
            }
            const text = donut.querySelector('.ats-score-text');
            if (text) text.textContent = score + '%';
          }
          // Update score label and summary
          const scoreLabel = document.querySelector('.ats-score-label');
          if (scoreLabel) scoreLabel.textContent = score + ' / 100';
          const scoreSummary = document.querySelector('.ats-score-summary');
          if (scoreSummary) scoreSummary.textContent = summary;
        });
      }
      // NOTE: Resume Feedback page should read the last uploaded resume from localStorage (key: 'lastUploadedResume') if present.
      
      // --- UPGRADE BUTTON HANDLERS ---
      // Map features to minimum required plan (aligned with navigation.js PLANS config)
      function getMinPlanForFeature(featureKey) {
        const featureToPlanMap = {
          'feedback': 'essential',    // Essential+ features (trial, essential, pro, premium)
          'interview': 'essential',   // Essential+ features (trial, essential, pro, premium)
          'rewriting': 'pro',        // Pro+ features
          'coverLetter': 'pro',       // Pro+ features
          'mockInterview': 'pro',     // Pro+ features
          'linkedin': 'premium',      // Premium only
          'priorityReview': 'premium' // Premium only
        };
        return featureToPlanMap[featureKey] || 'essential';
      }

      // Handle upgrade button clicks
      async function handleUpgradeClick(featureKey) {
        const user = window.FirebaseAuthManager?.getCurrentUser?.();
        if (!user) {
          alert('Please log in to upgrade your plan');
          window.location.href = 'login.html';
          return;
        }

        const targetPlan = getMinPlanForFeature(featureKey);
        console.log(`üîÑ [DASHBOARD] User clicked upgrade for ${featureKey}, targeting plan: ${targetPlan}`);

        try {
          // Get fresh token - force refresh if needed
          let idToken;
          try {
            idToken = await user.getIdToken(true); // Force refresh
          } catch (tokenError) {
            console.error('‚ùå [DASHBOARD] Failed to get Firebase token:', tokenError);
            alert('Your session has expired. Please log in again and try upgrading.');
            window.location.href = 'login.html';
            return;
          }

          if (!idToken) {
            alert('Your session has expired. Please log in again and try upgrading.');
            window.location.href = 'login.html';
            return;
          }

          // Call Stripe checkout API with the target plan
          const response = await fetch('/api/stripe-checkout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${idToken}`
            },
            body: JSON.stringify({
              plan: targetPlan
            })
          });

          // Check if response is ok before parsing JSON
          if (!response.ok) {
            const errorText = await response.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || 'Unknown error' };
            }

            // Handle specific error cases
            if (response.status === 401 || response.status === 403) {
              console.error('‚ùå [DASHBOARD] Authentication error:', errorData.error);
              alert('Your session has expired. Please log in again and try upgrading.');
              window.location.href = 'login.html';
              return;
            }

            console.error('‚ùå [DASHBOARD] Stripe checkout failed:', errorData.error);
            const rawError = (errorData && typeof errorData.error === 'string') ? errorData.error.trim() : '';
            const sanitized = rawError.startsWith('<!DOCTYPE') || rawError.startsWith('<html') ? 'server_error' : (rawError || 'Unknown error');
            alert('Unable to start checkout. Please try again. (' + sanitized + ')');
            // Fallback to pricing page
            window.location.href = `pricing-a.html?plan=${targetPlan}`;
            return;
          }

          const data = await response.json();

          if (data.ok && data.url) {
            // Redirect to Stripe Checkout
            console.log('‚úÖ [DASHBOARD] Redirecting to Stripe Checkout:', data.url);
            window.location.href = data.url;
          } else {
            console.error('‚ùå [DASHBOARD] Stripe checkout failed:', data.error);
            alert('Unable to start checkout. Please try again or visit our pricing page.');
            // Fallback to pricing page
            window.location.href = `pricing-a.html?plan=${targetPlan}`;
          }
        } catch (error) {
          console.error('‚ùå [DASHBOARD] Upgrade error:', error);
          // Check if it's a network error or auth error
          if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
            alert('Network error. Please check your connection and try again.');
          } else {
            alert('Failed to start upgrade. Please try again.');
          }
          // Fallback to pricing page
          window.location.href = `pricing-a.html?plan=${targetPlan}`;
        }
      }

      // Attach click handlers to all locked upgrade buttons
      const lockedButtons = document.querySelectorAll('.btn-locked[data-feature-key]');
      lockedButtons.forEach(button => {
        const featureKey = button.getAttribute('data-feature-key');
        if (featureKey) {
          button.addEventListener('click', (e) => {
            e.preventDefault();
            handleUpgradeClick(featureKey);
          });
        }
      });
      console.log(`‚úÖ [DASHBOARD] Attached ${lockedButtons.length} upgrade button handlers`);
    }

    // Billing portal helper function
    async function openBillingPortal(event) {
      event.preventDefault();
      
      try {
        const user = window.FirebaseAuthManager?.getCurrentUser?.();
        if (!user) {
          alert('Please log in to manage your subscription');
          return;
        }
        
        const idToken = await user.getIdToken();
        const res = await fetch('/api/billing-portal', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        const data = await res.json();
        
        if (data.ok && data.url) {
          window.location.href = data.url;
        } else {
          alert('Unable to open billing portal: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Billing portal error:', e);
        alert('Failed to open billing portal. Please try again.');
      }
    }
  </script>
  <!-- Load Firebase auth for token retrieval -->
  <script type="module" src="js/firebase-auth.js?v=20251011-1"></script>
  <!-- Load navigation system -->
  <script src="js/navigation.js?v=20251011-1"></script>
  <script>
    // DO NOT call initializeNavigation synchronously on dashboard
    // Wait for DOMContentLoaded so Firebase auth module has time to load
    window.addEventListener('DOMContentLoaded', async function() {
      // Wait for FirebaseAuthManager to be available (it's a module script)
      let waitCount = 0;
      while (!window.FirebaseAuthManager && waitCount < 50) {
        await new Promise(resolve => setTimeout(resolve, 100)); // Wait up to 5 seconds
        waitCount++;
      }
      
      if (window.JobHackAINavigation && typeof window.JobHackAINavigation.initializeNavigation === 'function') {
        window.JobHackAINavigation.initializeNavigation();
      }
    });
  </script>
  <script src="js/main.js" type="module"></script>
  <script src="js/analytics.js" type="module"></script>
  <script type="module">
    import authManager from './js/firebase-auth.js';

    (async () => {
      console.log('üìã dashboard guard v3 running');
      
      // Require verified email before allowing dashboard access
      const isVerified = await authManager.requireVerifiedEmail();
      if (!isVerified) {
        console.log('üö´ User not verified or not authenticated ‚Äî redirecting');
        return; // requireVerifiedEmail handles the redirect
      }
      
      console.log('‚úÖ Verified user accessing dashboard');
    })();
  </script>
</body>
</html> 
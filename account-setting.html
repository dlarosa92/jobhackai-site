<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html.auth-pending{visibility:hidden}
    body.account-protected .account-settings-wrapper { display: none; }
    body.account-protected main { display: none; }
    body.account-protected #profile-skeleton { display: none; }
    body.account-protected #profile-content { display: none; }
  </style>
  <script src="js/static-auth-guard.js?v=20251007-2"></script>
  <script>
    // Single consolidated auth check - wait for firebase-auth-ready event
    let authCheckComplete = false;
    document.addEventListener("firebase-auth-ready", function (event) {
      if (authCheckComplete) return; // Prevent duplicate checks
      authCheckComplete = true;
      
      const mgr = window.FirebaseAuthManager;
      const user = mgr ? mgr.getCurrentUser() : null;
      
      // Check if user is authenticated via multiple methods
      const hasLocalStorageAuth = localStorage.getItem('user-authenticated') === 'true' && !!localStorage.getItem('user-email');
      
      if (!user && !hasLocalStorageAuth) {
        console.log('üîí No authenticated user found, redirecting to login');
        window.location.href = "/login.html";
        return;
      }
      
      // If we have localStorage auth but no Firebase user yet, wait a bit more
      if (!user && hasLocalStorageAuth) {
        console.log('‚è≥ Waiting for Firebase auth to sync...');
        setTimeout(() => {
          const retryUser = mgr ? mgr.getCurrentUser() : null;
          if (!retryUser) {
            console.log('üîí Firebase auth not available after wait, redirecting to login');
            window.location.href = "/login.html";
            return;
          }
          checkEmailVerification(retryUser);
        }, 2000);
        return;
      }
      
      checkEmailVerification(user);
    });
    
    function checkEmailVerification(user) {
      if (!user) {
        window.location.href = "/login.html";
        return;
      }
      
      // Reload user to get latest verification status
      user.reload().then(() => {
        if (!user.emailVerified) {
          console.log('üìß User email not verified, redirecting to verify page');
          window.location.href = "/verify-email.html?email=" + encodeURIComponent(user.email || "");
          return;
        }
        // user is verified, show content
        console.log('‚úÖ User authenticated and verified, showing account settings');
        document.body.classList.remove("account-protected");
      }).catch((error) => {
        // If reload fails, don't trust stale emailVerified value - be conservative
        // Redirect to verify page to force fresh verification check
        console.warn('‚ö†Ô∏è Failed to reload user verification status:', error);
        console.log('üîí Reload failed - redirecting to verify page for fresh check');
        window.location.href = "/verify-email.html?email=" + encodeURIComponent(user.email || "");
      });
    }
    
    // Fallback: If firebase-auth-ready doesn't fire within 10 seconds, check manually
    setTimeout(() => {
      if (!authCheckComplete) {
        console.log('‚è∞ Firebase auth ready event timeout, checking manually');
        authCheckComplete = true;
        const mgr = window.FirebaseAuthManager;
        const user = mgr ? mgr.getCurrentUser() : null;
        const hasLocalStorageAuth = localStorage.getItem('user-authenticated') === 'true' && !!localStorage.getItem('user-email');
        
        if (!user && !hasLocalStorageAuth) {
          console.log('üîí Manual check: No auth found, redirecting to login');
          window.location.href = "/login.html";
        } else if (user) {
          checkEmailVerification(user);
        } else {
          // Has localStorage auth but no Firebase user - redirect to login to re-auth
          console.log('üîí Manual check: localStorage auth but no Firebase user, redirecting');
          window.location.href = "/login.html";
        }
      }
    }, 10000);
    
    // default: hide
    document.body.classList.add("account-protected");
  </script>
  <title>Account Settings ‚Äì JobHackAI</title>
  <link rel="icon" type="image/png" href="assets/JobHackAI_Logo_favicon-32x32.png">
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/footer.css">
  <style>
    .account-settings-card {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 2px 12px rgba(31,41,55,0.07);
      max-width: 700px;
      margin: 2.5rem auto;
      padding: 2.2rem 2rem 2rem 2rem;
    }
    .account-settings-card h1 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 1.2rem;
      color: #232B36;
    }
    .settings-section {
      margin-bottom: 1.5rem;
    }
    .settings-label {
      font-weight: 700;
      color: #232B36;
      font-size: 1.08rem;
      margin-bottom: 0.2rem;
      display: block;
    }
    .settings-readonly {
      background: #F3F4F6;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1rem;
      font-size: 1.05rem;
      color: #4B5563;
      width: 100%;
      margin-bottom: 0.2rem;
      outline: none;
    }
    .settings-support-link {
      font-size: 0.98rem;
      color: #1976D2;
      text-decoration: underline;
      margin-left: 0.2rem;
      cursor: pointer;
    }
    .settings-support-link:hover {
      color: #125bb5;
    }
    .settings-note {
      font-size: 0.97rem;
      color: #6B7280;
      margin-bottom: 0.2rem;
    }
    .settings-btn-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.2rem;
    }
    .btn-green {
      background: #00E676;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.3rem;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background 0.18s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-green:hover,
    .btn-green:focus {
      background: #00c965;
    }
    .btn-blue {
      background: #1976D2;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.3rem;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background 0.18s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-blue:hover,
    .btn-blue:focus {
      background: #125bb5;
    }
    .btn-grey {
      background: #232B36;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.3rem;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background 0.18s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-grey:hover,
    .btn-grey:focus {
      background: #111827;
    }
    .settings-link-row {
      margin: 1.2rem 0 1.5rem 0;
      font-size: 1.01rem;
    }
    .settings-link-row a {
      color: #1976D2;
      text-decoration: underline;
      margin-left: 0.2rem;
    }
    .settings-link-row a:hover {
      color: #125bb5;
    }
    .settings-divider {
      border: none;
      border-top: 1px solid #E5E7EB;
      margin: 2rem 0 1.5rem 0;
    }
    .btn-outline {
      background: #fff;
      color: #1976D2;
      border: 1.5px solid #1976D2;
      font-weight: 600;
      border-radius: 8px;
      padding: 0.6rem 1.3rem;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, border-color 0.18s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-outline:hover,
    .btn-outline:focus {
      background: #1976D2;
      color: #fff;
      border-color: #1976D2;
    }
    .btn-outline-grey {
      background: #fff;
      color: #232B36;
      border: 1.5px solid #B0B3B8;
      font-weight: 600;
      border-radius: 8px;
      padding: 0.6rem 1.3rem;
      font-size: 1.01rem;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, border-color 0.18s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-outline-grey:hover,
    .btn-outline-grey:focus {
      background: #232B36;
      color: #fff;
      border-color: #232B36;
    }
    .btn-link {
      background: none;
      color: #1976D2;
      border: none;
      font-weight: 600;
      font-size: 1.01rem;
      text-decoration: underline;
      cursor: pointer;
      padding: 0.6rem 0.7rem;
      border-radius: 6px;
      transition: background 0.18s, color 0.18s;
      display: inline-flex;
      align-items: center;
    }
    .btn-link:hover,
    .btn-link:focus {
      background: #F3F4F6;
      color: #125bb5;
    }
  </style>
</head>
<body>
  <!-- Header (canonical) -->
  <header class="site-header">
    <div class="container">
      <a href="index.html" class="nav-logo" aria-label="Go to homepage">
        <svg width="24" height="24" fill="none" stroke="#1F2937" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="18" height="13" rx="2"/>
          <path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
        <span>JOBHACKAI</span>
      </a>
      <div class="nav-group">
        <nav class="nav-links" role="navigation">
          <a href="index.html">Home</a>
          <a href="#what-you-get">What You Get</a>
          <a href="pricing-a.html">Pricing</a>
          <a href="index.html#blog">Blog</a>
          <a href="login.html">Login</a>
          <a href="pricing-a.html" class="cta-button">Start Free Trial</a>
        </nav>
      </div>
      <button class="mobile-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mobileNav">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </header>
  <nav class="mobile-nav" id="mobileNav">
    <a href="index.html">Home</a>
    <a href="#what-you-get">What You Get</a>
    <a href="pricing-a.html">Pricing</a>
    <a href="index.html#blog">Blog</a>
    <a href="login.html">Login</a>
    <a href="pricing-a.html" class="cta-button">Start Free Trial</a>
  </nav>
  <main>
    <!-- Skeleton Loading State -->
    <div id="profile-skeleton" class="account-settings-card" style="padding-bottom:1.5rem; display: none;">
      <h1>Account Settings</h1>
      <div style="margin-bottom:2.2rem;">
        <div style="width: 150px; height: 20px; background: #E5E7EB; border-radius: 4px; margin-bottom: 1rem;"></div>
        <div style="display:flex; gap:2.5rem; flex-wrap:wrap;">
          <div style="flex:1 1 260px; max-width:340px;">
            <div style="width: 80px; height: 16px; background: #E5E7EB; border-radius: 4px; margin-bottom: 0.5rem;"></div>
            <div style="width: 100%; height: 38px; background: #F3F4F6; border-radius: 4px;"></div>
          </div>
          <div style="flex:1 1 260px; max-width:340px;">
            <div style="width: 60px; height: 16px; background: #E5E7EB; border-radius: 4px; margin-bottom: 0.5rem;"></div>
            <div style="width: 100%; height: 38px; background: #F3F4F6; border-radius: 4px;"></div>
          </div>
        </div>
      </div>
      <div style="width: 200px; height: 40px; background: #E5E7EB; border-radius: 8px;"></div>
    </div>
    
    <!-- Actual Content -->
    <div id="profile-content" class="account-settings-card" style="padding-bottom:1.5rem; display: none;">
      <h1>Account Settings</h1>
      <!-- Profile Info Card -->
      <div class="settings-block" style="margin-bottom:2.2rem;">
        <div class="settings-label" style="margin-bottom:0.5rem;">Profile Information</div>
        <div class="profile-info-row" style="display:flex; flex-direction:row; gap:2.5rem; flex-wrap:wrap;">
          <div style="flex:1 1 260px; max-width:340px;">
            <span class="settings-label" style="font-weight:600; font-size:1.01rem; margin-bottom:0.1rem;">Full Name</span>
            <div id="profile-name" class="settings-readonly" style="background:#F3F4F6; font-size:1.04rem; padding:0.6rem 1rem;">Loading...</div>
          </div>
          <div style="flex:1 1 260px; max-width:340px;">
            <span class="settings-label" style="font-weight:600; font-size:1.01rem; margin-bottom:0.1rem;">Email</span>
            <div id="profile-email" class="settings-readonly" style="background:#F3F4F6; font-size:1.04rem; padding:0.6rem 1rem;">Loading...</div>
          </div>
        </div>
        <div class="settings-note" style="margin-top:0.5rem;">Need to update your name or email? <a class="settings-support-link" href="#">Contact Support</a></div>
      </div>
      <!-- Security Card -->
      <div class="settings-block" style="margin-bottom:2.2rem;">
        <div class="settings-label" style="margin-bottom:0.5rem;">Security</div>
        <button class="btn-outline" type="button" style="margin-bottom:0.2rem;" onclick="resetPassword()">Reset My Password</button>
      </div>
      <!-- Dynamic Billing Section -->
      <div id="billing-section-dynamic" class="settings-block" style="margin-bottom:2.2rem;">
        <div class="settings-label" style="margin-bottom:0.5rem;">Subscription</div>
        <div style="color: #6B7280;">Loading subscription details...</div>
      </div>
      <!-- Actions Row -->
      <div class="settings-actions-row" style="display:flex; gap:1rem; margin-bottom:2.2rem; flex-wrap:wrap;">
        <a href="#" class="btn-link">Compare Plans</a>
        <a href="#" class="btn-link">Contact Support</a>
        <button class="btn-outline-grey" type="button" data-action="logout">Log Out</button>
      </div>
    </div>
    <div style="max-width:700px; margin:0 auto 2.5rem auto; display:flex; justify-content:flex-start;">
      <a href="dashboard.html" class="btn-outline">&larr; Back to Dashboard</a>
    </div>
  </main>
  <!-- Footer (canonical) -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-brand">
        <svg class="footer-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="18" height="13" rx="2" stroke="#1F2937" stroke-width="2"/>
          <path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2" stroke="#1F2937" stroke-width="2"/>
        </svg>
        <span class="footer-name">JOBHACKAI</span>
      </div>
      <div class="footer-legal">
        <p>¬© 2025 JobHackAI. All rights reserved.</p>
      </div>
      <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="support.html">Support</a>
        <a href="privacy.html">Privacy</a>
      </div>
    </div>
  </footer>
  <!-- Removed duplicate checkAuthentication - now handled by firebase-auth-ready event -->
  <!-- Load navigation system -->
  <script src="js/navigation.js?v=20251007-2"></script>
  <script src="js/universal-logout.js?v=20251007-2"></script>
  <script>
    // DO NOT call initializeNavigation synchronously on auth-protected pages
    // Wait for DOMContentLoaded so Firebase auth module has time to load
    window.addEventListener('DOMContentLoaded', async function() {
      // Wait for FirebaseAuthManager to be available (it's a module script)
      let waitCount = 0;
      while (!window.FirebaseAuthManager && waitCount < 50) {
        await new Promise(resolve => setTimeout(resolve, 100)); // Wait up to 5 seconds
        waitCount++;
      }
      
      if (window.JobHackAINavigation && typeof window.JobHackAINavigation.initializeNavigation === 'function') {
        window.JobHackAINavigation.initializeNavigation();
      }
    });
  </script>
  
  <!-- Account Settings Functionality -->
  <script type="module" src="js/firebase-auth.js"></script>
  <script type="module" src="js/firestore-profiles.js"></script>
  <script>
    // --- BILLING PORTAL FUNCTION ---
    async function openBillingPortal() {
      try {
        const user = window.FirebaseAuthManager?.getCurrentUser?.();
        if (!user) {
          alert('Please log in again.');
          return;
        }

        const idToken = await user.getIdToken();
        if (!idToken) {
          alert('Unable to get authentication token. Please log in again.');
          return;
        }

        console.log('üîµ [ACCOUNT-SETTINGS] Opening billing portal...');
        
        const res = await fetch('/api/billing-portal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`
          }
        });

        // Handle 404 specifically - likely deployment issue
        if (res.status === 404) {
          console.error('‚ùå [ACCOUNT-SETTINGS] Billing portal endpoint not found (404)');
          alert('Billing portal service is not available. Please contact support or try again later.');
          return;
        }

        // Handle non-JSON responses
        let data;
        try {
          data = await res.json();
        } catch (jsonError) {
          console.error('‚ùå [ACCOUNT-SETTINGS] Failed to parse response:', jsonError);
          alert(`Error: ${res.status} ${res.statusText}. Please try again or contact support.`);
          return;
        }

        if (data.ok && data.url) {
          console.log('‚úÖ [ACCOUNT-SETTINGS] Redirecting to billing portal');
          window.location.href = data.url; // Redirect to Stripe portal
        } else {
          const errorMsg = data.error || 'Unknown error';
          console.error('‚ùå [ACCOUNT-SETTINGS] Billing portal error:', errorMsg);
          
          // Provide specific error messages
          if (errorMsg.includes('No customer')) {
            alert('No subscription found. Please subscribe to a plan first.');
          } else if (errorMsg.includes('unauthorized')) {
            alert('Your session has expired. Please log in again.');
          } else {
            alert(`Unable to open billing portal: ${errorMsg}. Please try again or contact support.`);
          }
        }
      } catch (error) {
        console.error('‚ùå [ACCOUNT-SETTINGS] Billing portal exception:', error);
        
        // Provide more specific error messages
        if (error.message?.includes('Failed to fetch')) {
          alert('Network error. Please check your internet connection and try again.');
        } else {
          alert(`Unable to open billing portal: ${error.message || 'Unknown error'}. Please try again or contact support.`);
        }
      }
    }
    
    // --- RENDER BILLING SECTION ---
    async function renderBillingSection() {
      const billingSection = document.getElementById('billing-section-dynamic');
      if (!billingSection) return;
      
      try {
        const user = window.FirebaseAuthManager?.getCurrentUser?.();
        if (!user) {
          billingSection.innerHTML = '<div style="color: #6B7280;">Please log in to view subscription details.</div>';
          return;
        }
        
        const idToken = await user.getIdToken();
        // Use billing-status API to get authoritative plan from Stripe
        const res = await fetch('/api/billing-status', {
          headers: { Authorization: `Bearer ${idToken}` }
        });
        
        if (!res.ok) {
          billingSection.innerHTML = '<div style="color: #EF4444;">Failed to load subscription details.</div>';
          return;
        }
        
        const data = await res.json();
        if (!data.ok) {
          billingSection.innerHTML = '<div style="color: #EF4444;">Failed to load subscription details.</div>';
          return;
        }
        
        const plan = data.plan || 'free';
        
        // Plan name mapping
        const planNames = {
          free: 'Free Account',
          trial: 'Trial (3 days)',
          essential: 'Essential',
          pro: 'Pro',
          premium: 'Premium'
        };
        
        const planPrices = {
          free: 'Free',
          trial: 'Free for 3 days',
          essential: '$29/month',
          pro: '$59/month',
          premium: '$99/month'
        };
        
        let html = '<div class="settings-label" style="margin-bottom:0.5rem;">Subscription</div>';
        
        if (plan === 'free') {
          html += `
            <div style="margin-bottom:0.8rem;">
              <div style="font-size:1.1rem;font-weight:600;color:#232B36;">Free Account</div>
              <div style="color:#6B7280;font-size:0.98rem;margin-top:0.2rem;">Limited features ‚Ä¢ Upgrade anytime</div>
            </div>
            <a href="pricing-a.html" class="btn-primary" style="text-decoration:none;display:inline-block;">View Plans</a>
          `;
        } else {
          html += `<div style="margin-bottom:0.8rem;">`;
          
          // Show trial status with days left
          if (plan === 'trial' && data.trialEndsAt) {
            const trialEndDate = new Date(data.trialEndsAt);
            const daysLeft = Math.ceil((trialEndDate - new Date()) / (1000 * 60 * 60 * 24));
            const trialEndDateStr = trialEndDate.toLocaleDateString('en-US', { 
              year: 'numeric', month: 'long', day: 'numeric' 
            });
            html += `<div style="font-size:1.1rem;font-weight:600;color:#232B36;">Trial Plan</div>`;
            html += `<div style="color:#6B7280;font-size:0.98rem;margin-top:0.2rem;">${daysLeft > 0 ? `${daysLeft} day${daysLeft !== 1 ? 's' : ''} left` : 'Trial ended'} ‚Ä¢ Ends on ${trialEndDateStr}</div>`;
            if (daysLeft > 0) {
              html += `<div style="background:#FEF3C7;border-left:4px solid #F59E0B;color:#92400E;padding:0.6rem 0.8rem;border-radius:6px;margin-top:0.8rem;font-size:0.95rem;">
                ‚è∞ Your trial will convert to Essential Plan ($29/month) on ${trialEndDateStr}
              </div>`;
            }
          } else {
            html += `<div style="font-size:1.1rem;font-weight:600;color:#232B36;">${planNames[plan]} Plan</div>`;
            html += `<div style="color:#6B7280;font-size:0.98rem;margin-top:0.2rem;">${planPrices[plan]}</div>`;
            
            // Show next renewal date for active subscriptions
            if (data.currentPeriodEnd && data.status === 'active') {
              const renewDate = new Date(data.currentPeriodEnd).toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
              });
              html += `<div style="color:#6B7280;font-size:0.92rem;margin-top:0.4rem;">Renews on ${renewDate}</div>`;
            }
          }
          
          html += `</div>`;
          html += `<button class="btn-outline" type="button" onclick="openBillingPortal()">Manage Subscription</button>`;
        }
        
        billingSection.innerHTML = html;
        
      } catch (e) {
        console.error('Error rendering billing section:', e);
        billingSection.innerHTML = '<div style="color: #EF4444;">Error loading subscription details.</div>';
      }
    }
    
    // --- RESET PASSWORD FUNCTION ---
    async function resetPassword() {
      const user = window.FirebaseAuthManager?.getCurrentUser?.();
      if (!user || !user.email) {
        alert('Please log in again.');
        return;
      }
      
      if (confirm(`Send password reset email to ${user.email}?`)) {
        try {
          const authManager = (await import('./js/firebase-auth.js')).default;
          const result = await authManager.resetPassword(user.email);
          if (result.success) {
            alert(`Password reset email sent to ${user.email}. Please check your inbox.`);
          } else {
            alert(result.error || 'Failed to send reset email.');
          }
        } catch (error) {
          console.error('Password reset error:', error);
          alert('Failed to send reset email. Please try again.');
        }
      }
    }
    
    // --- MAIN INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
      // Show skeleton immediately
      document.getElementById('profile-skeleton').style.display = 'block';
      
      // Wait for Firebase auth with longer timeout and better checks
      let user = window.FirebaseAuthManager?.getCurrentUser?.();
      
      // Also check localStorage as fallback
      const hasLocalStorageAuth = localStorage.getItem('user-authenticated') === 'true' && !!localStorage.getItem('user-email');
      
      if (!user && !hasLocalStorageAuth) {
        // No auth at all - redirect handled by static-auth-guard or firebase-auth-ready handler
        console.log('‚è≥ Waiting for auth...');
        // Don't redirect here - let the firebase-auth-ready handler do it
        return;
      }
      
      // If we have localStorage auth but no Firebase user, wait a bit more for Firebase to sync
      if (!user && hasLocalStorageAuth) {
        console.log('‚è≥ Waiting for Firebase auth to sync with localStorage...');
        let retries = 0;
        const maxRetries = 10; // 10 * 500ms = 5 seconds
        while (!user && retries < maxRetries) {
          await new Promise(r => setTimeout(r, 500));
          user = window.FirebaseAuthManager?.getCurrentUser?.();
          retries++;
        }
        
        if (!user) {
          console.log('‚ö†Ô∏è Firebase auth not synced after wait, but localStorage has auth - proceeding anyway');
          // Don't redirect - let the page try to load with localStorage auth
          // The firebase-auth-ready handler will handle redirect if needed
        }
      }
      
      // If still no user after all checks, firebase-auth-ready handler will redirect
      if (!user && !hasLocalStorageAuth) {
        return;
      }
      
      // Load real user data
      // Ensure we have a user object before proceeding
      if (!user) {
        console.warn('‚ö†Ô∏è No user object available, cannot load profile');
        // Fallback to localStorage email if available
        const email = localStorage.getItem('user-email') || 'User';
        document.getElementById('profile-name').textContent = 'User';
        document.getElementById('profile-email').textContent = email;
        await renderBillingSection();
        document.getElementById('profile-skeleton').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';
        return;
      }
      
      try {
        const profileResult = await UserProfileManager.getProfile(user.uid);
        
        // Handle Firestore permission errors gracefully - don't block page access
        if (profileResult.isPermissionError) {
          console.log('‚ÑπÔ∏è Firestore permission denied - using Firebase user data only');
          // Permission error is non-critical, use Firebase user data
          const userName = user.displayName || 
            user.email?.split('@')[0] ||
            'User';
          
          document.getElementById('profile-name').textContent = userName;
          document.getElementById('profile-email').textContent = user.email || 'user@example.com';
        } else if (profileResult.success && profileResult.profile) {
          // Profile loaded successfully
          const profile = profileResult.profile;
          const userName = profile.displayName || 
            `${profile.firstName || ''} ${profile.lastName || ''}`.trim() || 
            user.displayName ||
            user.email?.split('@')[0] ||
            'User';
          
          document.getElementById('profile-name').textContent = userName;
          document.getElementById('profile-email').textContent = user.email || 'user@example.com';
        } else {
          // Profile not found or failed to load - use Firebase user data
          console.log('‚ÑπÔ∏è Profile not found or failed to load - using Firebase user data');
          const userName = user.displayName || 
            user.email?.split('@')[0] ||
            'User';
          
          document.getElementById('profile-name').textContent = userName;
          document.getElementById('profile-email').textContent = user.email || 'user@example.com';
        }
        
        // Render billing section (may also fail with permission errors - that's OK)
        await renderBillingSection();
        
        // Hide skeleton, show content
        document.getElementById('profile-skeleton').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';
      } catch (error) {
        console.error('‚ö†Ô∏è Failed to load profile:', error);
        // Error loading profile - still show page with basic info
        // This ensures Firestore permission errors don't block access
        const userName = user.displayName || 
          user.email?.split('@')[0] ||
          'User';
        
        document.getElementById('profile-name').textContent = userName;
        document.getElementById('profile-email').textContent = user.email || 'user@example.com';
        
        // Try to render billing section even if profile failed
        try {
          await renderBillingSection();
        } catch (billingError) {
          console.warn('‚ö†Ô∏è Billing section also failed:', billingError);
          // Billing section failure is non-critical
        }
        
        // Always show the page content
        document.getElementById('profile-skeleton').style.display = 'none';
        document.getElementById('profile-content').style.display = 'block';
      }
      
      // Add delete account functionality
      const dangerZone = document.createElement('div');
      dangerZone.className = 'settings-block';
      dangerZone.style.cssText = 'margin-top: 3rem; border-top: 2px solid #fee; padding-top: 2rem;';
      dangerZone.innerHTML = `
        <div class="settings-label" style="color: #dc2626; margin-bottom: 0.5rem;">Danger Zone</div>
        <p style="color: #6b7280; margin-bottom: 1rem;">Once you delete your account, there is no going back. Please be certain.</p>
        <button class="btn-outline-grey" onclick="deleteAccount()" style="background: #fee; border-color: #dc2626; color: #dc2626;">Delete Account</button>
      `;
      
      // Add to the end of the settings card
      const settingsCard = document.querySelector('.account-settings-card');
      if (settingsCard) {
        settingsCard.appendChild(dangerZone);
      }
    });
    
    async function deleteAccount() {
      const confirmed = confirm(
        'Are you sure you want to delete your account? This will:\\n\\n' +
        '‚Ä¢ Cancel your subscription\\n' +
        '‚Ä¢ Delete all your data\\n' +
        '‚Ä¢ Remove your saved resumes\\n\\n' +
        'This action cannot be undone!'
      );
      
      if (!confirmed) return;
      
      try {
        const user = window.FirebaseAuthManager?.getCurrentUser?.();
        if (!user) {
          alert('Your session has expired. Please log in again.');
          window.location.href = '/login.html';
          return;
        }

        const idToken = await user.getIdToken();
        if (!idToken) {
          alert('Unable to get authentication token. Please log in again.');
          window.location.href = '/login.html';
          return;
        }
        
        // Cancel subscription
        await fetch('/api/cancel-subscription', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${idToken}` }
        });
        
        // Delete account
        await user.delete();
        localStorage.clear();
        
        alert('Your account has been deleted.');
        window.location.href = 'index.html';
      } catch (error) {
        console.error('‚ùå [ACCOUNT-SETTINGS] Delete account error:', error);
        alert('Failed to delete account: ' + (error.message || 'Unknown error'));
      }
    }
  </script>
  
  <!-- Billing Integration Tests -->
  <script src="js/billing-integration-test.js"></script>
</body>
</html> 
<!-- DO NOT EDIT HEADER OR FOOTER PER-PAGE. Use canonical snippet from docs/snippets.md. -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>html.auth-pending{visibility:hidden}</style>
  <script src="js/static-auth-guard.js?v=20251007-2"></script>
  <script>
    // --- IMMEDIATE PAGE ACCESS CONTROL (Pro/Premium only) ---
    (function enforceAccessImmediate() {
      const isAuthenticated = localStorage.getItem('user-authenticated') === 'true' && !!localStorage.getItem('user-email');
      const plan = localStorage.getItem('user-plan') || 'free';
      const allowedPlans = ['pro', 'premium'];
      
      if (!isAuthenticated) {
        console.log('ðŸš« [MOCK-INT] Not authenticated, redirecting to login');
        window.location.href = 'login.html';
        return;
      }
      
      if (!allowedPlans.includes(plan)) {
        console.log('ðŸš« [MOCK-INT] Access denied for plan:', plan);
        // Redirect with upgrade message
        window.location.href = 'interview-questions.html?upgrade=mock-interview';
        return;
      }
      
      console.log('âœ… [MOCK-INT] Access granted for plan:', plan);
    })();
  </script>
  <title>Mock Interviews with AI - JobHackAI</title>
  <link rel="icon" type="image/png" href="assets/jobhackai_icon_only_128.png">
  <link rel="apple-touch-icon" href="assets/jobhackai_icon_only_128.png">
  <script src="js/dynamic-favicon.js?v=20250111-1"></script>
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/footer.css">
  <style>
    /* Mock Interview Styles */
    .mi-main {
      max-width: 1100px;
      margin: 2rem auto 4rem auto;
      padding: 0 1rem;
    }
    
    .mi-layout {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 1.5rem;
      align-items: start;
    }
    
    @media (max-width: 900px) {
      .mi-layout {
        grid-template-columns: 1fr;
      }
    }
    
    .mi-card {
      background: var(--color-card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-card);
      padding: 1.75rem;
    }
    
    .mi-title {
      font-size: 1.75rem;
      font-weight: var(--font-weight-extrabold);
      color: var(--color-text-main);
      margin: 0 0 0.5rem 0;
    }
    
    .mi-subtitle {
      font-size: 1.05rem;
      color: var(--color-text-secondary);
      margin: 0 0 1.5rem 0;
      line-height: 1.5;
    }
    
    /* AI Coach Icon */
    .mi-coach-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem auto;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      border-radius: 50%;
      border: 3px solid var(--color-accent-blue);
    }
    
    .mi-coach-icon svg {
      width: 44px;
      height: 44px;
    }
    
    /* Form Fields */
    .mi-form-group {
      margin-bottom: 1.25rem;
    }
    
    .mi-label {
      display: block;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-main);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    
    .mi-input, .mi-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--color-divider);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      background: var(--color-card-bg);
      color: var(--color-text-main);
      transition: border-color var(--transition-fast);
      box-sizing: border-box;
    }
    
    .mi-input:focus, .mi-select:focus {
      border-color: var(--color-accent-blue);
      outline: none;
    }
    
    /* Segmented Control */
    .mi-segmented {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .mi-segment {
      flex: 1;
      min-width: 80px;
      padding: 0.6rem 0.75rem;
      border: 2px solid var(--color-divider);
      border-radius: var(--radius-lg);
      background: var(--color-card-bg);
      color: var(--color-text-secondary);
      font-size: 0.9rem;
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      text-align: center;
      transition: all var(--transition-fast);
    }
    
    .mi-segment:hover {
      border-color: var(--color-accent-blue);
    }
    
    .mi-segment.active {
      background: #E3F2FD;
      border-color: var(--color-accent-blue);
      color: var(--color-accent-blue);
    }
    
    /* Radio Options */
    .mi-radio-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .mi-radio-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--color-text-main);
    }
    
    .mi-radio-option input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: var(--color-accent-blue);
    }
    
    /* Checklist */
    .mi-checklist {
      background: #F8FAFC;
      border-radius: var(--radius-lg);
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }
    
    .mi-checklist-title {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-main);
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }
    
    .mi-checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    
    .mi-checklist-item:last-child {
      margin-bottom: 0;
    }
    
    .mi-checklist-item svg {
      flex-shrink: 0;
      margin-top: 2px;
      color: var(--color-cta-green);
    }
    
    /* Primary CTA Button */
    .mi-btn-primary {
      width: 100%;
      background: var(--color-cta-green);
      color: #fff;
      border: none;
      border-radius: var(--radius-lg);
      font-size: 1.1rem;
      padding: 1rem;
      font-weight: var(--font-weight-bold);
      cursor: pointer;
      transition: background var(--transition-fast);
      box-shadow: var(--shadow-button);
    }
    
    .mi-btn-primary:hover:not(:disabled) {
      background: var(--color-cta-green-hover);
    }
    
    .mi-btn-primary:disabled {
      background: var(--color-disabled);
      cursor: not-allowed;
    }
    
    /* Session Meter */
    .mi-meter {
      background: #F8FAFC;
      border: 1px solid var(--color-divider);
      border-radius: var(--radius-lg);
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .mi-meter-text {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .mi-meter-bar {
      width: 100%;
      height: 8px;
      background: var(--color-divider);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .mi-meter-progress {
      height: 100%;
      background: var(--color-cta-green);
      transition: width var(--transition-normal);
    }
    
    .mi-meter-progress.warning {
      background: var(--color-warning);
    }
    
    .mi-meter-progress.danger {
      background: var(--color-error);
    }
    
    .mi-meter-warning {
      font-size: 0.85rem;
      color: var(--color-warning);
      margin-top: 0.5rem;
      font-weight: var(--font-weight-medium);
    }
    
    /* Session History Sidebar */
    .mi-history {
      position: sticky;
      top: 1rem;
    }
    
    .mi-history-title {
      font-weight: var(--font-weight-bold);
      color: var(--color-text-main);
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    
    .mi-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .mi-history-item {
      padding: 0.75rem;
      border: 1px solid var(--color-divider);
      border-radius: var(--radius-md);
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .mi-history-item:hover {
      background: #F8FAFC;
      border-color: var(--color-accent-blue);
    }
    
    .mi-history-date {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }
    
    .mi-history-role {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-main);
      font-size: 0.95rem;
      margin: 0.25rem 0;
    }
    
    .mi-history-score {
      font-size: 0.9rem;
      color: var(--color-accent-blue);
      font-weight: var(--font-weight-bold);
    }
    
    .mi-history-empty {
      color: var(--color-text-muted);
      font-style: italic;
      text-align: center;
      padding: 1rem;
      font-size: 0.9rem;
    }
    
    .mi-history-error {
      color: var(--color-error);
      text-align: center;
      padding: 1rem;
      font-size: 0.9rem;
    }
    
    .mi-history-retry {
      background: none;
      border: 1px solid var(--color-error);
      color: var(--color-error);
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }
    
    /* Interview In-Progress */
    .mi-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .mi-progress-pill {
      background: var(--color-accent-blue);
      color: #fff;
      padding: 0.4rem 0.8rem;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      font-weight: var(--font-weight-semibold);
    }
    
    .mi-progress-meta {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
    }
    
    .mi-question-container {
      margin-bottom: 1.25rem;
    }
    
    .mi-question-text {
      font-size: 1.25rem;
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-main);
      line-height: 1.4;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    
    .mi-ai-badge {
      flex-shrink: 0;
      width: 36px;
      height: 36px;
      background: var(--color-accent-blue);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: var(--font-weight-bold);
      font-size: 0.85rem;
    }
    
    .mi-answer-area {
      width: 100%;
      min-height: 150px;
      padding: 1rem;
      border: 2px solid var(--color-divider);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-family: inherit;
      line-height: 1.6;
      resize: vertical;
      transition: border-color var(--transition-fast);
    }
    
    .mi-answer-area:focus {
      border-color: var(--color-accent-blue);
      outline: none;
    }
    
    /* S+A=O Helper Strip */
    .mi-sao-strip {
      display: flex;
      justify-content: space-between;
      background: #F0F9FF;
      border: 1px solid #BFDBFE;
      border-radius: var(--radius-md);
      padding: 0.6rem 1rem;
      margin-top: 0.75rem;
      font-size: 0.85rem;
    }
    
    .mi-sao-item {
      text-align: center;
      color: var(--color-text-secondary);
    }
    
    .mi-sao-label {
      font-weight: var(--font-weight-semibold);
      color: var(--color-accent-blue);
    }
    
    /* Word Counter */
    .mi-word-counter {
      text-align: right;
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin-top: 0.5rem;
    }
    
    .mi-word-counter.short {
      color: var(--color-warning);
    }
    
    /* Low word nudge */
    .mi-short-nudge {
      background: #FEF3C7;
      border: 1px solid var(--color-warning);
      border-radius: var(--radius-md);
      padding: 0.6rem 0.8rem;
      font-size: 0.9rem;
      color: #92400E;
      margin-top: 0.75rem;
      display: none;
    }
    
    .mi-short-nudge.visible {
      display: block;
    }
    
    /* Navigation Buttons */
    .mi-nav-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.25rem;
      gap: 1rem;
    }
    
    .mi-btn-secondary {
      background: none;
      border: 2px solid var(--color-divider);
      color: var(--color-text-secondary);
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .mi-btn-secondary:hover:not(:disabled) {
      border-color: var(--color-accent-blue);
      color: var(--color-accent-blue);
    }
    
    .mi-btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .mi-btn-next {
      background: var(--color-cta-green);
      color: #fff;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: var(--font-weight-bold);
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    
    .mi-btn-next:hover {
      background: var(--color-cta-green-hover);
    }
    
    /* Scoring Overlay */
    .mi-scoring-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-modal-backdrop);
      align-items: center;
      justify-content: center;
    }
    
    .mi-scoring-overlay.visible {
      display: flex;
    }
    
    .mi-scoring-modal {
      background: var(--color-card-bg);
      border-radius: var(--radius-xl);
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .mi-scoring-title {
      font-size: 1.25rem;
      font-weight: var(--font-weight-bold);
      color: var(--color-text-main);
      margin-bottom: 0.75rem;
    }
    
    .mi-scoring-text {
      font-size: 0.95rem;
      color: var(--color-text-secondary);
      line-height: 1.5;
    }
    
    .mi-scoring-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--color-divider);
      border-top-color: var(--color-accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 1.5rem auto 0;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Summary View */
    .mi-summary {
      display: none;
    }
    
    .mi-summary.visible {
      display: block;
    }
    
    .mi-score-hero {
      text-align: center;
      padding: 1.5rem;
      background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
      border-radius: var(--radius-xl);
      margin-bottom: 1.5rem;
    }
    
    .mi-score-value {
      font-size: 3rem;
      font-weight: var(--font-weight-extrabold);
      line-height: 1;
      margin-bottom: 0.5rem;
    }
    
    .mi-score-value.score-red { color: var(--color-error); }
    .mi-score-value.score-yellow { color: var(--color-warning); }
    .mi-score-value.score-green { color: var(--color-success); }
    .mi-score-value.score-blue { color: var(--color-accent-blue); }
    
    .mi-score-label {
      font-size: 1rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.75rem;
    }
    
    .mi-score-coaching {
      font-size: 0.95rem;
      color: var(--color-text-main);
      line-height: 1.5;
    }
    
    .mi-score-badge {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      margin-top: 0.75rem;
    }
    
    /* Rubric Grid */
    .mi-rubric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .mi-rubric-card {
      background: #F8FAFC;
      border-radius: var(--radius-lg);
      padding: 1rem;
      text-align: center;
    }
    
    .mi-rubric-label {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .mi-rubric-score {
      font-size: 1.5rem;
      font-weight: var(--font-weight-bold);
      color: var(--color-accent-blue);
    }
    
    .mi-rubric-note {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      margin-top: 0.5rem;
      line-height: 1.4;
    }
    
    /* S+A=O Analysis Card */
    .mi-sao-card {
      background: #F0F9FF;
      border: 1px solid #BFDBFE;
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    
    .mi-sao-title {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-main);
      margin-bottom: 1rem;
    }
    
    .mi-sao-breakdown {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .mi-sao-stat {
      text-align: center;
    }
    
    .mi-sao-pct {
      font-size: 1.5rem;
      font-weight: var(--font-weight-bold);
      color: var(--color-accent-blue);
    }
    
    .mi-sao-name {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }
    
    .mi-sao-target {
      font-size: 0.75rem;
      color: var(--color-text-muted);
    }
    
    .mi-sao-coaching {
      list-style: disc;
      padding-left: 1.25rem;
      margin: 0;
    }
    
    .mi-sao-coaching li {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    
    /* Improvements Section */
    .mi-section-title {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-main);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    
    .mi-improvements-list {
      list-style: decimal;
      padding-left: 1.5rem;
      margin: 0 0 1.5rem 0;
    }
    
    .mi-improvements-list li {
      font-size: 0.95rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    
    /* Per-Question Accordion */
    .mi-accordion {
      border: 1px solid var(--color-divider);
      border-radius: var(--radius-lg);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    
    .mi-accordion-item {
      border-bottom: 1px solid var(--color-divider);
    }
    
    .mi-accordion-item:last-child {
      border-bottom: none;
    }
    
    .mi-accordion-header {
      width: 100%;
      background: none;
      border: none;
      padding: 1rem;
      text-align: left;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      color: var(--color-text-main);
      transition: background var(--transition-fast);
    }
    
    .mi-accordion-header:hover {
      background: #F8FAFC;
    }
    
    .mi-accordion-header svg {
      transition: transform var(--transition-fast);
    }
    
    .mi-accordion-item.open .mi-accordion-header svg {
      transform: rotate(180deg);
    }
    
    .mi-accordion-q-score {
      font-weight: var(--font-weight-bold);
      color: var(--color-accent-blue);
      margin-left: auto;
      margin-right: 0.5rem;
    }
    
    .mi-accordion-content {
      display: none;
      padding: 0 1rem 1rem;
    }
    
    .mi-accordion-item.open .mi-accordion-content {
      display: block;
    }
    
    .mi-accordion-answer {
      background: #F8FAFC;
      border-radius: var(--radius-md);
      padding: 0.75rem;
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.75rem;
      line-height: 1.5;
      max-height: 100px;
      overflow-y: auto;
    }
    
    .mi-accordion-notes {
      list-style: disc;
      padding-left: 1.25rem;
      margin: 0;
    }
    
    .mi-accordion-notes li {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.35rem;
    }
    
    /* Summary Actions */
    .mi-summary-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    
    .mi-summary-actions .mi-btn-primary {
      flex: 1;
      min-width: 200px;
    }
    
    .mi-summary-actions .mi-btn-secondary {
      flex: 1;
      min-width: 150px;
    }
    
    /* Hidden state */
    .hidden {
      display: none !important;
    }
    
    /* Role Autocomplete */
    .mi-role-autocomplete {
      position: relative;
    }
    
    .mi-role-dropdown {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      background: var(--color-card-bg);
      border: 2px solid var(--color-divider);
      border-top: none;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      box-shadow: var(--shadow-dropdown);
      z-index: var(--z-dropdown);
      max-height: 220px;
      overflow-y: auto;
      display: none;
    }
    
    .mi-role-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--color-text-main);
      transition: background var(--transition-fast);
    }
    
    .mi-role-item:hover, .mi-role-item.active {
      background: #F3F4F6;
    }
    
    .mi-role-item-sub {
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <a href="index.html" class="nav-logo" aria-label="Go to homepage">
        <svg width="24" height="24" fill="none" stroke="#1F2937" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="18" height="13" rx="2"/>
          <path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
        <span>JOBHACKAI</span>
      </a>
      <div class="nav-group">
        <nav class="nav-links" role="navigation"></nav>
      </div>
      <button class="mobile-toggle" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mobileNav">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </header>
  <nav class="mobile-nav" id="mobileNav"></nav>
  <div class="mobile-nav-backdrop" id="mobileNavBackdrop"></div>

  <!-- Main Content -->
  <main class="mi-main">
    <div class="mi-layout">
      <!-- Left Column: Main Content Area -->
      <div>
        <!-- Setup Screen -->
        <div class="mi-card" id="mi-setup">
          <div class="mi-coach-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#1976D2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8V4H8"/>
              <rect x="4" y="4" width="16" height="16" rx="2"/>
              <path d="M8 12h8"/>
              <path d="M8 16h5"/>
              <circle cx="16" cy="16" r="2"/>
            </svg>
          </div>
          
          <h1 class="mi-title">Mock Interviews with AI</h1>
          <p class="mi-subtitle">Practice 10 real interview questions, then get scored and coached on how to improve.</p>
          
          <!-- Target Role -->
          <div class="mi-form-group">
            <label class="mi-label" for="mi-role">Target Role</label>
            <div class="mi-role-autocomplete">
              <input type="text" id="mi-role" class="mi-input" placeholder="Start typing a role..." autocomplete="off">
              <div class="mi-role-dropdown" id="mi-role-dropdown"></div>
            </div>
          </div>
          
          <!-- Seniority -->
          <div class="mi-form-group">
            <label class="mi-label" for="mi-seniority">Seniority</label>
            <select id="mi-seniority" class="mi-select">
              <option value="">Select level...</option>
              <option value="intern">Intern</option>
              <option value="junior">Junior</option>
              <option value="mid">Mid</option>
              <option value="senior">Senior</option>
              <option value="lead">Lead</option>
              <option value="director">Director+</option>
            </select>
          </div>
          
          <!-- Interview Style -->
          <div class="mi-form-group">
            <label class="mi-label">Interview Style</label>
            <div class="mi-segmented" id="mi-style">
              <button type="button" class="mi-segment active" data-value="mixed">Mixed</button>
              <button type="button" class="mi-segment" data-value="behavioral">Behavioral</button>
              <button type="button" class="mi-segment" data-value="technical">Technical</button>
              <button type="button" class="mi-segment" data-value="leadership">Leadership</button>
            </div>
          </div>
          
          <!-- Question Source -->
          <div class="mi-form-group">
            <label class="mi-label">Question Source</label>
            <div class="mi-radio-group">
              <label class="mi-radio-option">
                <input type="radio" name="mi-source" value="ai" checked>
                Use AI-generated questions
              </label>
              <label class="mi-radio-option">
                <input type="radio" name="mi-source" value="saved">
                Use my saved set
              </label>
            </div>
            <select id="mi-saved-set" class="mi-select hidden" style="margin-top: 0.5rem;">
              <option value="">Select a saved set...</option>
            </select>
          </div>
          
          <!-- What to Expect -->
          <div class="mi-checklist">
            <div class="mi-checklist-title">What to expect</div>
            <div class="mi-checklist-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
              <span>10 questions, about 10â€“15 minutes.</span>
            </div>
            <div class="mi-checklist-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
              <span>Use Situation â†’ Action â†’ Outcome to structure your answers.</span>
            </div>
            <div class="mi-checklist-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
              <span>We'll score you out of 100 and save this session to your history.</span>
            </div>
          </div>
          
          <!-- Start Button -->
          <button type="button" class="mi-btn-primary" id="mi-start" disabled>Start Mock Interview</button>
          
          <!-- Session Meter -->
          <div class="mi-meter" id="mi-meter">
            <div class="mi-meter-text">Sessions used this month: <span id="mi-sessions-used">0</span> / <span id="mi-sessions-limit">20</span></div>
            <div class="mi-meter-bar">
              <div class="mi-meter-progress" id="mi-meter-progress" style="width: 0%"></div>
            </div>
            <div class="mi-meter-warning hidden" id="mi-meter-warning"></div>
          </div>
        </div>
        
        <!-- Interview In-Progress -->
        <div class="mi-card hidden" id="mi-interview">
          <div class="mi-progress-header">
            <span class="mi-progress-pill" id="mi-q-pill">Question 1 of 10</span>
            <span class="mi-progress-meta" id="mi-q-meta">Role: Software Engineer Â· Senior Â· Mixed</span>
          </div>
          
          <div class="mi-question-container">
            <div class="mi-question-text">
              <span class="mi-ai-badge">AI</span>
              <span id="mi-question">Loading question...</span>
            </div>
          </div>
          
          <textarea id="mi-answer" class="mi-answer-area" placeholder="Use Situation â†’ Action â†’ Outcome. Focus most on what changed because of your work."></textarea>
          
          <!-- S+A=O Helper Strip -->
          <div class="mi-sao-strip">
            <div class="mi-sao-item"><span class="mi-sao-label">Situation</span><br>goal â‰ˆ 5%</div>
            <div class="mi-sao-item"><span class="mi-sao-label">Action</span><br>goal â‰ˆ 10%</div>
            <div class="mi-sao-item"><span class="mi-sao-label">Outcome</span><br>goal â‰ˆ 85%</div>
          </div>
          
          <div class="mi-word-counter" id="mi-word-counter">0 words Â· Aim for 150â€“250 words (â‰ˆ 60â€“90 seconds)</div>
          
          <div class="mi-short-nudge" id="mi-short-nudge">
            This answer is quite short. Consider adding more detail before moving on.
          </div>
          
          <div class="mi-nav-buttons">
            <button type="button" class="mi-btn-secondary" id="mi-back" disabled>Back</button>
            <button type="button" class="mi-btn-next" id="mi-next">Next</button>
          </div>
          
          <!-- Meter during interview -->
          <div class="mi-meter" style="margin-top: 1.5rem;">
            <div class="mi-meter-text">Sessions used this month: <span id="mi-sessions-used-2">0</span> / <span id="mi-sessions-limit-2">20</span></div>
            <div class="mi-meter-bar">
              <div class="mi-meter-progress" id="mi-meter-progress-2" style="width: 0%"></div>
            </div>
          </div>
        </div>
        
        <!-- Summary View -->
        <div class="mi-card mi-summary hidden" id="mi-summary">
          <div class="mi-score-hero">
            <div class="mi-score-value score-blue" id="mi-final-score">74 / 100</div>
            <div class="mi-score-label">Mock Interview Score</div>
            <div class="mi-score-coaching" id="mi-score-coaching">Loading feedback...</div>
            <div class="mi-score-badge" id="mi-score-badge">Saved to history Â· Today Â· Data Engineer Â· Senior</div>
          </div>
          
          <!-- Rubric Breakdown -->
          <div class="mi-rubric-grid" id="mi-rubric-grid">
            <!-- Populated by JS -->
          </div>
          
          <!-- S+A=O Analysis -->
          <div class="mi-sao-card">
            <div class="mi-sao-title">How you balanced Situation, Action, and Outcome</div>
            <div class="mi-sao-breakdown" id="mi-sao-breakdown">
              <!-- Populated by JS -->
            </div>
            <ul class="mi-sao-coaching" id="mi-sao-coaching-list">
              <!-- Populated by JS -->
            </ul>
          </div>
          
          <!-- Top Improvements -->
          <div>
            <div class="mi-section-title">Next time, focus on:</div>
            <ol class="mi-improvements-list" id="mi-improvements-list">
              <!-- Populated by JS -->
            </ol>
          </div>
          
          <!-- Per-Question Accordion -->
          <div class="mi-accordion" id="mi-accordion">
            <!-- Populated by JS -->
          </div>
          
          <!-- Summary Actions -->
          <div class="mi-summary-actions">
            <button type="button" class="mi-btn-primary" id="mi-retake">Retake this interview</button>
            <button type="button" class="mi-btn-secondary" id="mi-new-questions">Practice new questions</button>
            <a href="dashboard.html" class="mi-btn-secondary" style="text-decoration: none; text-align: center;">Back to Dashboard</a>
          </div>
        </div>
      </div>
      
      <!-- Right Column: Session History -->
      <aside class="mi-card mi-history">
        <div class="mi-history-title">Session History</div>
        <ul class="mi-history-list" id="mi-history-list">
          <li class="mi-history-empty">No previous mock interviews yet. Once you finish a session, your score and date will appear here.</li>
        </ul>
      </aside>
    </div>
  </main>
  
  <!-- Scoring Overlay -->
  <div class="mi-scoring-overlay" id="mi-scoring-overlay">
    <div class="mi-scoring-modal">
      <div class="mi-scoring-title">Scoring your interviewâ€¦</div>
      <div class="mi-scoring-text">We're reviewing your 10 answers using our S + A = O formula and interview rubric. This usually takes a few seconds.</div>
      <div class="mi-scoring-spinner"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-brand">
        <svg class="footer-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="7" width="18" height="13" rx="2" stroke="#1F2937" stroke-width="2"/>
          <path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2" stroke="#1F2937" stroke-width="2"/>
        </svg>
        <span class="footer-name">JOBHACKAI</span>
      </div>
      <div class="footer-legal">
        <p>Â© 2025 JobHackAI. All rights reserved.</p>
      </div>
      <div class="footer-links">
        <a href="index.html">Home</a>
        <a href="support.html">Support</a>
        <a href="privacy.html">Privacy</a>
      </div>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/navigation.js?v=20251007-2"></script>
  <script src="js/universal-logout.js?v=20251007-2"></script>
  <script type="module" src="js/firebase-auth.js?v=20251011-1"></script>
  <script src="js/role-selector.js?v=20250115-1" type="module"></script>
  <script src="js/main.js" type="module"></script>
  <script src="js/analytics.js" type="module"></script>
  
  <script type="module">
    // ============================================================
    // MOCK INTERVIEW PAGE LOGIC
    // ============================================================
    
    // State
    const state = {
      currentScreen: 'setup', // 'setup' | 'interview' | 'summary'
      role: '',
      seniority: '',
      interviewStyle: 'mixed',
      questionSource: 'ai',
      savedSetId: null,
      savedSets: [],
      savedSetsLoaded: false,
      questions: [],
      answers: [],
      currentQuestionIndex: 0,
      sessionsUsed: 0,
      sessionLimit: 20,
      scoringResult: null,
      sessionId: null,
      shortNudgeAcknowledged: false
    };
    
    // DOM Elements
    const els = {
      setup: document.getElementById('mi-setup'),
      interview: document.getElementById('mi-interview'),
      summary: document.getElementById('mi-summary'),
      scoringOverlay: document.getElementById('mi-scoring-overlay'),
      roleInput: document.getElementById('mi-role'),
      senioritySelect: document.getElementById('mi-seniority'),
      styleSegments: document.querySelectorAll('#mi-style .mi-segment'),
      sourceRadios: document.querySelectorAll('input[name="mi-source"]'),
      savedSetSelect: document.getElementById('mi-saved-set'),
      startBtn: document.getElementById('mi-start'),
      meterProgress: document.getElementById('mi-meter-progress'),
      meterProgress2: document.getElementById('mi-meter-progress-2'),
      sessionsUsed: document.getElementById('mi-sessions-used'),
      sessionsUsed2: document.getElementById('mi-sessions-used-2'),
      sessionsLimit: document.getElementById('mi-sessions-limit'),
      sessionsLimit2: document.getElementById('mi-sessions-limit-2'),
      meterWarning: document.getElementById('mi-meter-warning'),
      qPill: document.getElementById('mi-q-pill'),
      qMeta: document.getElementById('mi-q-meta'),
      questionText: document.getElementById('mi-question'),
      answerArea: document.getElementById('mi-answer'),
      wordCounter: document.getElementById('mi-word-counter'),
      shortNudge: document.getElementById('mi-short-nudge'),
      backBtn: document.getElementById('mi-back'),
      nextBtn: document.getElementById('mi-next'),
      historyList: document.getElementById('mi-history-list')
    };
    
    // API endpoints
    const API = {
      generateQuestions: '/api/mock-interview/generate-questions',
      score: '/api/mock-interview/score',
      sessions: '/api/mock-interview/sessions',
      sessionDetail: (id) => `/api/mock-interview/sessions/${id}`,
      savedSets: '/api/interview-questions/get-set'
    };
    
    // Get Firebase token
    async function getToken() {
      try {
        if (window.FirebaseAuthManager && window.FirebaseAuthManager.waitForAuthReady) {
          await window.FirebaseAuthManager.waitForAuthReady(3000);
        }
        if (window.FirebaseAuthManager && window.FirebaseAuthManager.getCurrentUser) {
          const user = window.FirebaseAuthManager.getCurrentUser();
          if (user) {
            return await user.getIdToken();
          }
        }
      } catch (e) {
        console.warn('[MI] Failed to get Firebase token:', e);
      }
      return null;
    }
    
    // Initialize Role Selector
    function initRoleSelector() {
      if (window.RoleSelector && !els.roleInput.dataset.roleSelectorInitialized) {
        try {
          new window.RoleSelector(els.roleInput, {
            minChars: 2,
            maxResults: 8,
            showCustomOption: true,
            onSelect: (roleName) => {
              state.role = roleName;
              checkCanStart();
            }
          });
          els.roleInput.dataset.roleSelectorInitialized = 'true';
        } catch (e) {
          console.warn('[MI] RoleSelector init failed:', e);
        }
      } else {
        // Retry
        setTimeout(initRoleSelector, 200);
      }
    }
    
    // Check if user can start interview
    function checkCanStart() {
      const roleValid = els.roleInput.value.trim().length > 0;
      const seniorityValid = els.senioritySelect.value !== '';
      const canStart = roleValid && seniorityValid && state.sessionsUsed < state.sessionLimit;
      els.startBtn.disabled = !canStart;
    }
    
    // Update session meter
    function updateMeter() {
      const pct = Math.min(100, (state.sessionsUsed / state.sessionLimit) * 100);
      const progressClass = pct >= 100 ? 'danger' : pct >= 75 ? 'warning' : '';
      
      els.meterProgress.style.width = `${pct}%`;
      els.meterProgress.className = 'mi-meter-progress ' + progressClass;
      els.sessionsUsed.textContent = state.sessionsUsed;
      els.sessionsLimit.textContent = state.sessionLimit;
      
      if (els.meterProgress2) {
        els.meterProgress2.style.width = `${pct}%`;
        els.meterProgress2.className = 'mi-meter-progress ' + progressClass;
        els.sessionsUsed2.textContent = state.sessionsUsed;
        els.sessionsLimit2.textContent = state.sessionLimit;
      }
      
      if (pct >= 100) {
        els.meterWarning.textContent = 'Monthly session limit reached. Next reset: ' + getNextResetDate();
        els.meterWarning.classList.remove('hidden');
        els.startBtn.disabled = true;
        els.startBtn.textContent = 'Monthly session limit reached';
      } else if (pct >= 75) {
        els.meterWarning.textContent = "You're nearing your monthly limit. Focus on your top roles.";
        els.meterWarning.classList.remove('hidden');
      } else {
        els.meterWarning.classList.add('hidden');
      }
    }
    
    function getNextResetDate() {
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      return nextMonth.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    // Fetch session history
    async function fetchHistory() {
      try {
        const token = await getToken();
        if (!token) return;
        
        const res = await fetch(`${API.sessions}?limit=3`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to fetch history');
        
        const data = await res.json();
        
        if (data.usage) {
          state.sessionsUsed = data.usage.sessionsUsed || 0;
          state.sessionLimit = data.usage.sessionLimit || 20;
          updateMeter();
        }
        
        renderHistory(data.sessions || []);
      } catch (e) {
        console.error('[MI] History fetch error:', e);
        els.historyList.innerHTML = `
          <li class="mi-history-error">
            We couldn't load your previous sessions.
            <button class="mi-history-retry" onclick="location.reload()">Try again</button>
          </li>
        `;
      }
    }
    
    // Fetch saved question sets for dropdown
    async function fetchSavedSets() {
      try {
        const token = await getToken();
        if (!token) return;
        
        const res = await fetch(`${API.savedSets}?list=1`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load saved sets');
        
        const data = await res.json();
        const sets = data.sets || [];
        state.savedSets = sets;
        state.savedSetsLoaded = true;
        renderSavedSets(sets);
      } catch (e) {
        console.error('[MI] Saved sets fetch error:', e);
        state.savedSetsLoaded = true;
        renderSavedSets([]);
      }
    }
    
    function renderSavedSets(sets) {
      if (!sets.length) {
        els.savedSetSelect.innerHTML = '<option value="">No saved sets yet</option>';
        return;
      }
      
      els.savedSetSelect.innerHTML = [
        '<option value="">Select a saved set...</option>',
        ...sets.map(s => {
          const count = typeof s.selectedCount === 'number' ? s.selectedCount : (Array.isArray(s.selectedIndices) ? s.selectedIndices.length : (Array.isArray(s.questions) ? s.questions.length : 0));
          return `<option value="${s.id}">${escapeHtml(s.role || 'Saved set')} (${count || 0} questions)</option>`;
        })
      ].join('');
    }
    
    function renderHistory(sessions) {
      if (!sessions.length) {
        els.historyList.innerHTML = '<li class="mi-history-empty">No previous mock interviews yet. Once you finish a session, your score and date will appear here.</li>';
        return;
      }
      
      els.historyList.innerHTML = sessions.map(s => {
        const date = new Date(s.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        return `
          <li class="mi-history-item" data-session-id="${s.id}">
            <div class="mi-history-date">${date}</div>
            <div class="mi-history-role">${escapeHtml(s.role || '')}</div>
            <div class="mi-history-score">${s.overallScore} / 100</div>
          </li>
        `;
      }).join('');
      
      // Add click handlers
      els.historyList.querySelectorAll('.mi-history-item').forEach(item => {
        item.addEventListener('click', () => loadHistoricalSession(item.dataset.sessionId));
      });
    }
    
    // Load a historical session
    async function loadHistoricalSession(sessionId) {
      try {
        const token = await getToken();
        if (!token) return;
        
        els.scoringOverlay.classList.add('visible');
        
        const res = await fetch(API.sessionDetail(sessionId), {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load session');
        
        const data = await res.json();
        
        // Populate state from loaded session
        state.role = data.role;
        state.seniority = data.seniority;
        state.interviewStyle = data.interviewStyle;
        state.questions = data.qaPairs.map(qa => ({ text: qa.q }));
        state.answers = data.qaPairs.map(qa => qa.a);
        state.scoringResult = {
          overallScore: data.overallScore,
          rubric: data.rubric,
          saoOverall: data.saoOverall,
          strengths: data.strengths,
          improvements: data.improvements,
          perQuestion: data.perQuestion
        };
        state.sessionId = data.sessionId;
        
        els.scoringOverlay.classList.remove('visible');
        showSummary();
      } catch (e) {
        console.error('[MI] Load session error:', e);
        els.scoringOverlay.classList.remove('visible');
        alert('Failed to load session. Please try again.');
      }
    }
    
    // Start interview
    async function startInterview() {
      state.role = els.roleInput.value.trim();
      state.seniority = els.senioritySelect.value;
      state.answers = [];
      state.currentQuestionIndex = 0;
      state.savedSetId = null;
      
      els.startBtn.disabled = true;
      els.startBtn.textContent = 'Loading questions...';
      
      try {
        const token = await getToken();
        if (!token) throw new Error('Not authenticated');
        
        // Check question source
        if (state.questionSource === 'ai') {
          // Generate questions via API
          const res = await fetch(API.generateQuestions, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              role: state.role,
              seniority: state.seniority,
              interviewStyle: state.interviewStyle
            })
          });
          
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || 'Failed to generate questions');
          }
          
          const data = await res.json();
          state.questions = data.questions || [];
        } else {
          // Use saved set - fetch from API
          const setId = els.savedSetSelect.value;
          if (!setId) throw new Error('Please select a saved question set');
          
          const res = await fetch(`${API.savedSets}?id=${setId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!res.ok) throw new Error('Failed to load saved questions');
          
          const data = await res.json();
          const rawQuestions = data.questions || [];
          const selectedIdx = Array.isArray(data.selectedIndices) ? data.selectedIndices : [];
          const useSelected = selectedIdx.length > 0;
          const picked = useSelected
            ? selectedIdx
                .filter(idx => Number.isInteger(idx) && idx >= 0 && idx < rawQuestions.length)
                .map(idx => rawQuestions[idx])
            : rawQuestions;
          state.questions = picked.map(q => ({ text: typeof q === 'string' ? q : q?.q }));
          state.savedSetId = setId;
        }
        
        if (!state.questions.length) throw new Error('No questions available');
        
        // Initialize answers array
        state.answers = new Array(state.questions.length).fill('');
        
        // Show interview screen
        showInterview();
      } catch (e) {
        console.error('[MI] Start error:', e);
        alert(e.message || 'Failed to start interview. Please try again.');
      } finally {
        els.startBtn.disabled = false;
        els.startBtn.textContent = 'Start Mock Interview';
        checkCanStart();
      }
    }
    
    // Show interview screen
    function showInterview() {
      state.currentScreen = 'interview';
      els.setup.classList.add('hidden');
      els.summary.classList.add('hidden');
      els.interview.classList.remove('hidden');
      
      updateInterviewUI();
    }
    
    // Update interview UI for current question
    function updateInterviewUI() {
      const q = state.questions[state.currentQuestionIndex];
      const isLast = state.currentQuestionIndex === state.questions.length - 1;
      els.shortNudge.classList.remove('visible');
      state.shortNudgeAcknowledged = false;
      
      els.qPill.textContent = `Question ${state.currentQuestionIndex + 1} of ${state.questions.length}`;
      els.qMeta.textContent = `Role: ${state.role} Â· ${state.seniority} Â· ${state.interviewStyle}`;
      els.questionText.textContent = q.text;
      els.answerArea.value = state.answers[state.currentQuestionIndex] || '';
      
      els.backBtn.disabled = state.currentQuestionIndex === 0;
      els.nextBtn.textContent = isLast ? 'Finish' : 'Next';
      
      updateWordCounter();
    }
    
    // Update word counter
    function updateWordCounter() {
      const text = els.answerArea.value.trim();
      const words = text ? text.split(/\s+/).length : 0;
      els.wordCounter.textContent = `${words} words Â· Aim for 150â€“250 words (â‰ˆ 60â€“90 seconds)`;
      els.wordCounter.classList.toggle('short', words > 0 && words < 50);
    }
    
    // Save current answer and navigate
    function saveCurrentAnswer() {
      state.answers[state.currentQuestionIndex] = els.answerArea.value;
    }
    
    // Go to next question or finish
    async function handleNext() {
      saveCurrentAnswer();
      
      const answer = state.answers[state.currentQuestionIndex];
      const wordCount = answer.trim() ? answer.trim().split(/\s+/).length : 0;
      const isLast = state.currentQuestionIndex === state.questions.length - 1;
      
      // Show short nudge if < 20 words
      if (wordCount < 20 && wordCount > 0) {
        els.shortNudge.classList.add('visible');
        // Allow continuing after showing nudge once
        // Do not immediately redraw UI here; let nudge render first.
        if (!isLast) {
          // Give the browser a tick to render the nudge, then advance
          return setTimeout(() => {
            state.currentQuestionIndex++;
            updateInterviewUI();
          }, 0);
        }
        // Last question: require one acknowledgement click, then allow finish
        if (!state.shortNudgeAcknowledged) {
          state.shortNudgeAcknowledged = true;
          return;
        }
      }
      
      if (isLast) {
        // Finish interview - score it
        await scoreInterview();
      } else {
        state.currentQuestionIndex++;
        updateInterviewUI();
      }
    }
    
    // Go to previous question
    function handleBack() {
      if (state.currentQuestionIndex > 0) {
        saveCurrentAnswer();
        state.currentQuestionIndex--;
        updateInterviewUI();
      }
    }
    
    // Score the interview
    async function scoreInterview() {
      els.scoringOverlay.classList.add('visible');
      
      try {
        const token = await getToken();
        if (!token) throw new Error('Not authenticated');
        
        // Build Q&A pairs
        const qaPairs = state.questions.map((q, i) => ({
          q: q.text,
          a: state.answers[i] || ''
        }));
        
        const res = await fetch(API.score, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            role: state.role,
            seniority: state.seniority,
            interviewStyle: state.interviewStyle,
            questionSetId: state.savedSetId,
            questionSetName: state.questionSource === 'saved' ? els.savedSetSelect.options[els.savedSetSelect.selectedIndex]?.text : null,
            qaPairs
          })
        });
        
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Failed to score interview');
        }
        
        const data = await res.json();
        state.scoringResult = data;
        state.sessionId = data.sessionId;
        
        // Update usage
        state.sessionsUsed++;
        updateMeter();
        
        // Refresh history
        fetchHistory();
        
        // Show summary
        showSummary();
      } catch (e) {
        console.error('[MI] Scoring error:', e);
        alert(e.message || 'Failed to score interview. Please try again.');
      } finally {
        els.scoringOverlay.classList.remove('visible');
      }
    }
    
    // Show summary screen
    function showSummary() {
      state.currentScreen = 'summary';
      els.setup.classList.add('hidden');
      els.interview.classList.add('hidden');
      els.summary.classList.remove('hidden');
      
      const r = state.scoringResult;
      if (!r) return;
      
      // Score hero
      const scoreEl = document.getElementById('mi-final-score');
      scoreEl.textContent = `${r.overallScore} / 100`;
      scoreEl.className = 'mi-score-value ' + getScoreColorClass(r.overallScore);
      
      // Coaching
      const coaching = r.improvements?.[0] || 'Great job completing the interview!';
      document.getElementById('mi-score-coaching').textContent = coaching;
      
      // Badge
      const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      document.getElementById('mi-score-badge').textContent = `Saved to history Â· ${date} Â· ${state.role} Â· ${state.seniority}`;
      
      // Rubric grid
      const rubricGrid = document.getElementById('mi-rubric-grid');
      const rubricItems = [
        { label: 'Relevance of Answer', score: r.rubric?.relevance?.score || 0, of: 30, note: r.rubric?.relevance?.note || '' },
        { label: 'Structure & Delivery', score: r.rubric?.structure?.score || 0, of: 25, note: r.rubric?.structure?.note || '' },
        { label: 'Confidence & Clarity', score: r.rubric?.clarity?.score || 0, of: 20, note: r.rubric?.clarity?.note || '' },
        { label: 'Depth & Insight', score: r.rubric?.insight?.score || 0, of: 15, note: r.rubric?.insight?.note || '' },
        { label: 'Grammar & Pace', score: r.rubric?.grammar?.score || 0, of: 10, note: r.rubric?.grammar?.note || '' }
      ];
      rubricGrid.innerHTML = rubricItems.map(item => `
        <div class="mi-rubric-card">
          <div class="mi-rubric-label">${item.label}</div>
          <div class="mi-rubric-score">${item.score} / ${item.of}</div>
          <div class="mi-rubric-note">${escapeHtml(item.note || '')}</div>
        </div>
      `).join('');
      
      // S+A=O breakdown
      const saoBreakdown = document.getElementById('mi-sao-breakdown');
      const sao = r.saoOverall || { situationPct: 0, actionPct: 0, outcomePct: 0 };
      saoBreakdown.innerHTML = `
        <div class="mi-sao-stat">
          <div class="mi-sao-pct">${Math.round(sao.situationPct || sao.situation_pct || 0)}%</div>
          <div class="mi-sao-name">Situation</div>
          <div class="mi-sao-target">target â‰ˆ 5%</div>
        </div>
        <div class="mi-sao-stat">
          <div class="mi-sao-pct">${Math.round(sao.actionPct || sao.action_pct || 0)}%</div>
          <div class="mi-sao-name">Action</div>
          <div class="mi-sao-target">target â‰ˆ 10%</div>
        </div>
        <div class="mi-sao-stat">
          <div class="mi-sao-pct">${Math.round(sao.outcomePct || sao.outcome_pct || 0)}%</div>
          <div class="mi-sao-name">Outcome</div>
          <div class="mi-sao-target">target â‰ˆ 85%</div>
        </div>
      `;
      
      // S+A=O coaching
      const saoCoachingList = document.getElementById('mi-sao-coaching-list');
      const saoCoaching = sao.coaching || [];
      saoCoachingList.innerHTML = saoCoaching.map(c => `<li>${escapeHtml(c || '')}</li>`).join('');
      
      // Improvements
      const improvementsList = document.getElementById('mi-improvements-list');
      const improvements = r.improvements || [];
      improvementsList.innerHTML = improvements.map(i => `<li>${escapeHtml(i || '')}</li>`).join('');
      
      // Per-question accordion
      const accordion = document.getElementById('mi-accordion');
      const perQRaw = r.perQuestion || [];
      // Normalize per-question feedback using q_index so we don't rely on array order
      const perQByIndex = {};
      perQRaw.forEach((item, idx) => {
        const qIdx = typeof item.q_index === 'number' ? item.q_index : idx;
        if (perQByIndex[qIdx] === undefined) {
          perQByIndex[qIdx] = item;
        }
      });
      accordion.innerHTML = state.questions.map((q, i) => {
        const pq = perQByIndex[i] || {};
        const notes = pq.notes || [];
        return `
          <div class="mi-accordion-item">
            <button class="mi-accordion-header" type="button">
              <span>Q${i + 1} Â· "${escapeHtml(truncate(q.text, 50))}"</span>
              <span class="mi-accordion-q-score">${pq.score || 0}/10</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            <div class="mi-accordion-content">
              <div class="mi-accordion-answer">${escapeHtml(state.answers[i] || '(No answer)')}</div>
              <ul class="mi-accordion-notes">
                ${notes.map(n => `<li>${escapeHtml(n || '')}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
      }).join('');
      
      // Accordion toggle
      accordion.querySelectorAll('.mi-accordion-header').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.parentElement.classList.toggle('open');
        });
      });
    }
    
    function getScoreColorClass(score) {
      if (score >= 85) return 'score-blue';
      if (score >= 70) return 'score-green';
      if (score >= 50) return 'score-yellow';
      return 'score-red';
    }
    
    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.slice(0, len) + '...' : str;
    }
    
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    // Reset to setup
    function resetToSetup() {
      state.currentScreen = 'setup';
      state.questions = [];
      state.answers = [];
      state.currentQuestionIndex = 0;
      state.scoringResult = null;
      state.sessionId = null;
      
      els.setup.classList.remove('hidden');
      els.interview.classList.add('hidden');
      els.summary.classList.add('hidden');
      
      checkCanStart();
    }
    
    // Retake interview (same questions)
    function retakeInterview() {
      state.answers = new Array(state.questions.length).fill('');
      state.currentQuestionIndex = 0;
      state.scoringResult = null;
      state.sessionId = null;
      
      showInterview();
    }
    
    // Event Listeners
    function setupEventListeners() {
      // Role input
      els.roleInput.addEventListener('input', () => {
        state.role = els.roleInput.value.trim();
        checkCanStart();
      });
      
      // Seniority select
      els.senioritySelect.addEventListener('change', () => {
        state.seniority = els.senioritySelect.value;
        checkCanStart();
      });
      
      // Style segments
      els.styleSegments.forEach(seg => {
        seg.addEventListener('click', () => {
          els.styleSegments.forEach(s => s.classList.remove('active'));
          seg.classList.add('active');
          state.interviewStyle = seg.dataset.value;
        });
      });
      
      // Source radios
      els.sourceRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          state.questionSource = radio.value;
          els.savedSetSelect.classList.toggle('hidden', radio.value !== 'saved');
          if (radio.value === 'saved' && !state.savedSetsLoaded) {
            fetchSavedSets();
          }
        });
      });
      
      // Start button
      els.startBtn.addEventListener('click', startInterview);
      
      // Answer area
      els.answerArea.addEventListener('input', () => {
        updateWordCounter();
        els.shortNudge.classList.remove('visible');
      });
      
      // Navigation buttons
      els.nextBtn.addEventListener('click', handleNext);
      els.backBtn.addEventListener('click', handleBack);
      
      // Summary actions
      document.getElementById('mi-retake')?.addEventListener('click', retakeInterview);
      document.getElementById('mi-new-questions')?.addEventListener('click', () => {
        window.location.href = `interview-questions.html?role=${encodeURIComponent(state.role)}`;
      });
    }
    
    // Initialize
    async function init() {
      setupEventListeners();
      initRoleSelector();
      await fetchHistory();
      await fetchSavedSets();
      checkCanStart();
    }
    
    // Wait for DOM and Firebase
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
